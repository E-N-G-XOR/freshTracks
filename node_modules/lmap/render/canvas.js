"use strict";function t(i,e,o){o=this.options=n.deepMerge(t.options,o),this.map=i,this.init(e,o),this.styles(o),this.onDefaults()}var i=require("./../leaflet"),e=require("jquery"),o=i.dmap=i.dmap||{},n=require("bcore/utils"),s=window.requestAnimationFrame||window.mozRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/60)},a=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.mozCancelAnimationFrame||function(t){window.clearTimeout(t)};t.options={clearAlpha:1},t.prototype.init=function(t,i){var o=this.map;if("string"==typeof t){var n=o.getPanes();if(n[t]){t=n[t];var s=o.getSize();i.width=s.x,i.height=s.y,this.isMapPane=1}}t=this.node=e(t);var a,h=this.w=i.width||t.width(),r=this.h=i.height||t.height();if(t.is("div")){var c=this.quality=i.quality||2;a=e('<canvas width="'+h*c+'" height="'+r*c+'"><canvas>').css({position:"absolute",left:"0",top:"0",pointerEvents:"none",width:h+"px",height:r+"px"}),t.append(a),a=this.canvas=a[0];var p=this.ctx=a.getContext("2d");p.scale(c,c)}t.is("canvas")&&(a=this.canvas=t[0],this.ctx=a.getContext("2d"));var d=this.canvasTmp=e('<canvas width="'+a.width+'" height="'+a.height+'"><canvas>')[0];this.ctxTmp=d.getContext("2d")},t.prototype.styles=function(t){t=t||{};var i=t.lighter,e=this.ctx;i&&e&&(e.globalCompositeOperation="lighter");var o=t.opacity;void 0!==o&&null!==o&&e&&(e.globalAlpha=o)},t.prototype.onDefaults=function(){var t=this,i=this.clear.bind(this),e=this.resetPos.bind(this);this.map.on("zoomstart",function(){t.clear(1)}).on("zoomend",e).on("movestart",function(){}).on("resize",function(){i(1),e()}).on("moveend",e)},t.prototype.bind=function(t,i){this[t]&&this.map.off(t,this[t].bind(this)),this[t]=i,this.map.on(t,i.bind(this))},t.prototype.onZoomstart=function(t){this.bind("zoomstart",t)},t.prototype.onMovestart=function(t){this.bind("movestart",t)},t.prototype.onMoveend=function(t){this.bind("moveend",t)},t.prototype.onZoomend=function(t){this.bind("zoomend",t)},t.prototype.onUpdate=function(t){this.bind("moveend",t),this.bind("resize",t)},t.prototype.resetPos=function(){var t=this.canvas;if(this.isMapPane){var e=i.DomUtil.getPosition(this.map.getPanes().mapPane);e&&i.DomUtil.setPosition(t,{x:-e.x,y:-e.y})}this.clear(1)},t.prototype.clear=function(t){if((void 0===t||null===t)&&(t=this.options.clearAlpha),1===t)return this.ctx.clearRect(0,0,this.w,this.h);var i=this.canvasTmp,e=this.ctxTmp,o=this.canvas,n=this.ctx;e.globalAlpha=t,e.drawImage(o,0,0,this.w,this.h),n.clearRect(0,0,o.width,o.height),n.drawImage(i,0,0,o.width,o.height),e.clearRect(0,0,this.w,this.h)},t.prototype.destroy=function(){this.canvas.remove()},t.prototype.pt=function(t,i,e,o,n){n=n||o,this.ctx.drawImage(t,i-o/2,e-n/2,o,n)},t.prototype.test=function(){this.ctx.fillStyle="#900",this.ctx.fillRect(20,202,333+100*Math.random(),33),this.ctx.fillRect(24,223,33,333)},o.Canvas=t,o.canvas=function(i,e,o){return new t(i,e,o)},module.exports=t;