"use strict";function t(e,n){var o=e.content,a={position:"absolute",left:"0%",top:"0%",zIndex:1e3};i.forEach(a,function(t,e){o.style[e]=t}),this.options=s.deepMerge(t.options,n),this.stage=e,this.initEvents()}var e=require("bcore/event"),s=require("bcore/utils"),n=require("./../leaflet"),i=require("lodash");t.options={transition:"opacity 0.4s",blending:"lighter",lazyFresh:!0,ptNPerLayer:1e3},t=e.extend(t,{initEvents:function(){},beginDraw:function(){this.versionID=Math.random()},endDraw:function(){var t=this.shapes;for(var e in t){var s=t[e];s.__versionID!==this.versionID&&(s.destroy(),delete t[e])}this.lazyFresh()},cleanOld:function(){var t=this.versionID,e=this.cache,s=void 0,n=void 0,i=void 0;if(t&&e)for(var o in e)s=e[o],i=s.versionID,i!==t&&(n=s.visual,n&&(n.off&&n.off(),n.destroy&&n.destroy()),delete e[o])},addTo:function(t){this._map=t,this.resetVariables(),this.initEventsMap()},resetOffset:function(){this.pOffset=this.offset},disable:function(){this.isable=!1,this.stage.content.style.display="none"},enable:function(){this.isable=!0,this.stage.content.style.display="block"},resetVariables:function(){this.isable=!0,this.shapes={},this.layers=[],this.offset={x:0,y:0},this.pOffset={x:0,y:0}},add:function(t){this.stage.add(t)},addOrSetShape:function(t){var e,s=t.Constructor,n=t.index,i=t.attrs,o=t.data,a=t.id,r=this.shapes;if(r[a])return e=r[a],e.__options=t,e.__versionID=this.versionID,e.__data=o,e.__attr=i,r[a].setAttrs(i);var e=new s(i),h=this.getOrAddLayer(n);h.getCanvas().getContext("2d").globalCompositeOperation=this.options.blending,h.add(e),r[a]=e,e.scale={x:1.2,y:1.2},e.__options=t,e.__versionID=this.versionID,e.__data=o,e.__id=a,e.__attr=i},getOrAddLayer:function(t){if(this.isable){t=Math.floor(t/(this.options.shapeNPerLayer||this.options.ptNPerLayer));var e=this.layers,s=e[t];return s?s:(s=new Konva.Layer,e[t]=s,this.stage.add(s),s.canvas._canvas.style.zIndex=1e3-t,s)}},fresh:function(){this.layers.forEach(function(t){t.draw()})},lazyFresh:function(){this.isable&&this.lazyFreshDraw(0)},lazyFreshDraw:function(t){var e=this,s=this;t=t||0;var n=this.layers[t];return n?(n.draw(),this.resetPos(n.canvas._canvas,{x:s.offset.x-s.pOffset.x,y:s.offset.y-s.pOffset.y}),n.canvas._canvas.style.opacity=1,n.canvas._canvas.style.transition=this.options.lazyFresh.transition,t++,void(this.lazyFreshId=window.requestAnimationFrame(function(){e.lazyFreshDraw(t)}))):window.requestAnimationFrame(this.lazyFreshDone.bind(this))},lazyFreshDone:function(){this.resetPos(this.stage.content),this.layers.forEach(function(t){n.DomUtil.setPosition(t.canvas._canvas,{x:0,y:0})})},resetPos:function(t,e){e=e||n.DomUtil.getPosition(this._map.getPanes().mapPane),e&&n.DomUtil.setPosition(t,{x:-e.x,y:-e.y})},stopLazyFresh:function(){this.lazyFreshId&&(window.cancelAnimationFrame(this.lazyFreshId),this.lazyFreshId=null)},hideLayers:function(){this.layers.forEach(function(t){t.canvas._canvas.style.opacity=0})},updateOptions:function(t){this.options=s.deepMerge(this.options,t),this.updateBlending()},updateBlending:function(){var t=this.options;this.layers.forEach(function(e){e.getCanvas().getContext("2d").globalCompositeOperation=t.blending})},initEventsMap:function(){var t=this,e=this._map;e.on("zoomstart",function(){t.hideLayers(),t.stopLazyFresh()}).on("movestart",function(){t.stopLazyFresh()}).on("moveend",function(){t.pOffset=t.offset,t.offset=n.DomUtil.getPosition(e.getPanes().mapPane)}).on("resize",function(){})},onKonva:function(t,e){return this.stage.on(t,e),this},enableMapEvents:function(){var t=this.stage.content;n.DomEvent.off(t,"mousedown",n.DomEvent.stopPropagation),n.DomEvent.off(t,"mousemove",n.DomEvent.stopPropagation),n.DomEvent.off(t,"click",n.DomEvent.stopPropagation),this._map.options.draggable!==!1&&this._map.dragging.enable()},disableMapEvents:function(t){var e=this.stage.content;n.DomEvent.on(e,"mousedown",n.DomEvent.stopPropagation),n.DomEvent.on(e,"mousemove",n.DomEvent.stopPropagation),n.DomEvent.on(e,"click",n.DomEvent.stopPropagation),this._map.dragging.disable(),t&&t.evt.preventDefault()},clean:function(){var t=this.shapes;for(var e in t){var s=t[e];s.destroy(),delete t[e]}},destroy:function(){this.stage.clearCache(),this.stage.clear(),this.clean(),this.stage.destroy()}}),t.prototype=s.merge(t.prototype,require("./leaflet_layer_konva.editor")),module.exports=t;