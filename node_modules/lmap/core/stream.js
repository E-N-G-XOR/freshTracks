"use strict";function t(t){var i=0;for(var e in t)i++;return i}function i(t){return null===t||void 0===t||isNaN(t)}function e(t){this.options=r.deepMerge(this.options,t),this.localDatas={}}var a=require("bcore/event"),r=require("./utils");a.extend(e,{options:{isDeleteDiff:!0,getCellID:function(t,i,e){return"array"===e?t.id||"id_"+Math.floor(1e14*Math.random()):t.id||i||"id_"+Math.floor(1e14*Math.random())}},dataN:0,datasN:0,valueMax:null,valueMin:null,versionIdCount:0,getValue:function(t){return t.value},getVersionId:function(){return"version_id_"+this.versionIdCount++},write:function(t){if(t){var i,e,a,r=this.getVersionId(),n=this.localDatas,s={},o=this.options.getCellID;if(Array.isArray(t))for(a=0;a<t.length;a++)i=t[a],e=o(i,a,"array"),this.wrapper(e,i,n,r,s);else for(a in t)t.hasOwnProperty(a)&&(i=t[a],e=o(i,a,"object"),this.wrapper(e,i,n,r,s));if(this.options.isDeleteDiff)for(e in n)n[e]&&n[e].version!==r&&this.destroy(e);this.emit("update-data",s),this.emit("all-data",n),this.datasN++}},updateRange:function(t){var e=!1;if(this.getValue){var a=this.getValue(t);i(a)||(i(this.valueMax)&&(this.valueMax=a),i(this.valueMin)&&(this.valueMin=a),this.valueMax<a&&(this.valueMax=a,e=!0),this.valueMin>a&&(e=!0,this.valueMin=a),e&&this.emit("update-range",{max:this.valueMax,min:this.valueMin}))}},wrapper:function n(t,i,e,a,r){this.updateRange(i);var n=e[t];n?(n.data=i,n.version=a,n.action="update"):n=e[t]={id:t,data:i,version:a,action:"new"},r[t]=n,this.emit("update-row",n),this.dataN++},destroy:function(t){var i=this.localDatas;if(i){var e=i[t];this.emit("delete-row",e),delete i[t]}},destroyAll:function(){var t=this.localDatas;if(t)for(var i in t)this.destroy(i)}}),module.exports=e;