"use strict";function t(t,i,n){return i in t?Object.defineProperty(t,i,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[i]=n,t}function i(t){t=this.options=a.deepMerge(i.options,t),this.id=Math.floor(1e7*Math.random())+"_"+(new Date).getTime(),this.initialize(t)}var n,e=require("./../leaflet"),a=require("./../core/utils"),s=require("./../render/canvas"),r=a.getColorFunc,o=a.switchValue,l=require("bcore/event"),h=require("./../core/utils").getSprite;i.options=(n={container:null,lengthLimit:15,lifeSpeed:.5,delay:30,isAutoUpdate:!0,lineSegmentLonger:1},t(n,"container",null),t(n,"blending","lighter"),t(n,"sprite",{type:"linear",isContinue:!0,width:200,height:20,color:{from:"rgba(0,233,233,0.3)",to:"rgba(0,233,233,0.3)",space:"hsl",easing:"linear.Out.3"}}),t(n,"isable",!0),t(n,"isableDraw",!0),t(n,"type","line"),t(n,"ptsN",9),t(n,"weight",function(t,i){return 5*Math.pow(i,1)}),t(n,"pts",function(t){return t.pts}),t(n,"color",r("rgba(0,150,150,0.8)","rgba(0,100,255, 1)","rgb","linear.Out.1")),t(n,"scale",function(){return 1}),t(n,"size",function(){return 15}),t(n,"value",function(t){return Math.min(1,t.length/40)}),t(n,"lng",a.getLng),t(n,"lat",a.getLat),t(n,"time",a.getTime),n),i=l.extend(i,{events:{},includes:[e.Mixin.Events],initialize:function(){},addTo:function(t){!this._map&&t&&(this._map=t,this.initCanvas(),this._data&&this.draw())},initCanvas:function(){var t=this.options;if(t.ctx)return this.ctx=t.ctx;this.lcanvas=new s(this._map,t.container,{clearAlpha:1});var i=this.ctx=this.lcanvas.ctx;i.globalCompositeOperation=t.blending,this.ctx=i},processing:function(){for(var t,i,n,a,s,r,o,l=this.pts,h=this.options,u=h.time,c=h.lat,p=h.lng,g=t=u(l[0],0),d=i=p(l[0],0),f=n=c(l[0],0),b=0;b<l.length;b++)a=l[b],a&&(s=c(a),r=p(a),o=u(a,b),o>t&&(t=o),g>o&&(g=o),s>n&&(n=s),f>s&&(f=s),r>i&&(i=r),d>r&&(d=r));this.lifeMax=h.lifeMax=t,this.lifeMin=h.lifeMin=g;var v=e.latLng(f,d),m=e.latLng(n,i);this.bounds=e.latLngBounds(v,m)},getBBox:function(){return this.bounds},isInView:function(t){t=t||this._map.getBounds();var i=this.bounds,n=i._northEast.lng,e=i._northEast.lat,a=i._southWest.lng,s=i._southWest.lat,r=t._northEast.lng,o=t._northEast.lat,l=t._southWest.lng,h=t._southWest.lat;return!(a>l&&a>r||l>n&&r>n||s>h&&s>o||h>e&&o>e)},data:function(t){if(!t)return this._data;var i=this.options,n=i.pts.bind(i);this._data=t,this.pts=n(t),this.processing(),this.resetVariables()},append:function(t){return this._data?void this.pts.append(t):console.log("初始数据没有")},render:function(t){t&&this.data(t),this.draw()},updateOptions:function(t){t=this.options=a.deepMerge(this.options,t)},resetVariables:function(){this.enable(),this.life=this.options.lifeMin||this.lifeMin},enable:function(){this.options.isable=!0},disable:function(){this.options.isable=!1},enableDraw:function(){this.options.isableDraw=!0},disableDraw:function(){this.options.isableDraw=!1},equalTo:function(t){return this.id===t.id?!0:!1},draw:function(){var t=this.options;if(t.isable&&t.isableDraw){var i=(t.lengthLimit,t.lineSegmentLonger),n=this.ctx,a=h(t.sprite),s=this._map.latLngToContainerPoint.bind(this._map),r=this.pts;if(r)for(var l,u,c,p,g,d,f,b,v,m=r.length,w=a.width,_=a.height,M=1/m*w*1,x=t.lat.bind(t),L=t.lng.bind(t),C=0;m>C;C++){l=r[C];var q=x(l),D=L(l),y=s(e.latLng(q,D)),B=y.x,E=y.y;if(u=(C-1)/m,c||p){f=B-c,b=E-p,g=Math.atan2(b,f),d=Math.sqrt(f*f+b*b)+i,v=o(t.weight,l,u),n.save(),n.translate(c,p),n.rotate(g);var T=u*w;n.drawImage(a,T,0,M,_,0,-v/2,d,v),n.restore()}c=B,p=E}}},isEnd:function(){return this.life>=this.lifeMax+(this.options.delay||0)},updateMap:function(){this.draw()}});var u=e.dmap=e.dmap||{};u.TrailCanvasBg=i,u.trailCanvasBg=function(t){return new i(t)},module.exports=i;