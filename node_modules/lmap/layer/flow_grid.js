"use strict";var t=require("./../leaflet"),i=require("./../render/canvas");require("./../core/utils");var n=t.dmap=t.dmap||{},a=n.Utils,e=a.getSprite,s=t.Layer.extend({initialize:function(t){t=this.options=a.deepMerge(s.options,t),this.isable=!0},disable:function(){this.isable=!1},enable:function(){this.isable=!0},addTo:function(t){!this._map&&t&&(this._map=t,this.initCanvas(),this.initEventsMap(),this.updateBlending())},initCanvas:function(){var t=this._map,n=this.options,a=n.container;this.dCanvas=new i(t,a,n)},data:function(i,n){var a=this.options.sort;i=_.sortBy(i,a),n=n||{};var e=(this.map,this);this._data=i,this.transfer=n.transfer||function(i,n){return e._map.latLngToContainerPoint(t.latLng(i,n))},this.valueFunc=function(t){return t.value}||n.valueFunc},updateOptions:function(t){t&&(this.options=a.deepMerge(this.options,t)),this.updateBlending(),this.draw()},updateSprite:function(t){return t=t||this.options.sprite,t=e(t)},updateFilter:function(t){t&&"function"==typeof t&&(this.options.filter=t,this.draw())},updateBlending:function(t){return t?this.dCanvas.ctx.globalCompositeOperation=this.options.blending=t:void(this.dCanvas.ctx.globalCompositeOperation=this.options.blending)},render:function(t,i){t&&this.data(t),this.draw(i)},updateGrid:function(){var t=this._data;if(t){var i=500,n={};t.forEach(function(t){var a=Math.floor(t.lat*i)/i+"_"+Math.floor(t.lng*i)/i,e=n[a];if(e){var s=e.count+1;e.vx=(e.vx*e.count+t.vx)/s,e.vy=(e.vy*e.count+t.vy)/s,e.lat=(e.lat*e.count+t.lat)/s,e.lng=(e.lng*e.count+t.lng)/s,e.count=s}else n[a]={vx:t.vx,vy:t.vy,lat:t.lat,lng:t.lng,count:1}}),this.dataAggregate=_.values(n)}},draw:function(t){(t===!0||void 0===t)&&this.clean();var i=(this._map,this._map.getZoom(),this.options),n=!0,e=this.options.filter;if(this.isable){var s=this.transfer;this.updateGrid();{var o,r,h,u,l,c,d,v,p=this.dataAggregate,f=(this.valueFunc,this.sprites,this.dCanvas),g=i.lng,m=i.lat,b=i.vx,x=i.vy,w=(f.w,f.h,a.getColorFunc(i.stroke));i.groups}for(var y in p)if(o=p[y],o&&(e&&(n=e(o)),n&&(r=a.switchValue(g,o),h=a.switchValue(m,o),d=a.switchValue(b,o),v=a.switchValue(x,o),u=s(h,r),r&&h))){l=u.x,c=u.y;var M=f.ctx;M.beginPath();var C=i.maxLength,_=Math.max(Math.min(1,d/1e3),-1),L=_*C,F=Math.max(Math.min(1,v/1e3),-1),k=F*C,B=Math.max(Math.min(1,(Math.abs(d)+Math.abs(c))/800),0);M.strokeStyle=w(B),M.lineWidth=i.weight,M.moveTo(l,c),M.lineTo(l+L,c+k),M.stroke(),M.closePath()}}},clean:function(t){this.dCanvas.clear(t)},initEventsMap:function(){this.dCanvas.onUpdate(function(){this.draw()}.bind(this))},destroy:function(){this.dCanvas.destroy()}});s.options={lng:a.getLng,lat:a.getLat,vx:function(t){return t.vx},vy:function(t){return t.vy},filter:function(){return 1},weight:1,blending:"source-over",container:"tilePane",stroke:{from:"rgba(0,233,333,0.2)",to:"rgba(233, 0, 0, 0.5)",space:"hsl",easing:"linear.Out.3"},maxLength:30,sort:function(t){return-Math.abs(t.vx)+Math.abs(t.vy)},sprite:{drawN:1.15,color:{from:"rgba(245,230,0,0.3)",to:"rgba(245,245,0,0.04)",easing:"Linear.None.1.7",space:"rgb"}}},n.FlowGrid=s,n.flowGrid=function(t){return new s(t)},module.exports=s;