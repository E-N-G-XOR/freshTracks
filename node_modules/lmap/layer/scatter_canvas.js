"use strict";var t=require("./../leaflet"),i=require("./../render/canvas");require("./../core/utils");var n=t.dmap=t.dmap||{},e=n.Utils,s=e.getSprite,a=t.Layer.extend({initialize:function(t){t=this.options=e.deepMerge(a.options,t),this.isable=!0,this.sprite=this.updateSprite(t.sprite),this.updateGroups(t.groups)},disable:function(){this.isable=!1},enable:function(){this.isable=!0},addTo:function(t){!this._map&&t&&(this._map=t,this.initCanvas(),this.initEventsMap(),this.updateBlending())},initCanvas:function(){var t=this._map,n=this.options,e=n.container;this.dCanvas=new i(t,e,n)},data:function(i,n){if(i&&i.length){n=n||{};var e=(this.map,this);this._data=i,this.transfer=n.transfer||function(i,n){return e._map.latLngToContainerPoint(t.latLng(i,n))},this.processing()}},processing:function(){this.range=e.getRange(this._data,this.options.value)},updateOptions:function(t){t&&(this.options=e.deepMerge(this.options,t)),this.sprite=this.updateSprite(),this.updateBlending(),this.draw()},updateSprite:function(t){return s(t||this.options.sprite)},updateGroups:function(t){if(t)for(var i in t){var n=t[i];n.sprite&&(n.sprite=this.updateSprite(n.sprite))}},updateFilter:function(t){t&&"function"==typeof t&&(this.options.filter=t,this.draw())},updateBlending:function(t){this.dCanvas&&(this.dCanvas.ctx.globalCompositeOperation=this.options.blending||t)},render:function(t,i){t&&this.data(t),this.draw(i)},draw:function(t){t||this.clean();var i=this.range||{},n=i.min,s=i.max,a=this._map;if(this.isable&&a){var r=this._map.getZoom(),o=this.options,p=!0,h=this.options.filter,u=this.transfer,d=this._data;if(d&&d.length){var l,f,c,g,v,b,m,C,w=(this.options.value,this.sprites,this.dCanvas),_=o.lng.bind(o),y=o.lat.bind(o),L=w.w,S=w.h,x=o.groups;for(var z in d)if(f=d[z],f&&(h&&(p=h(f)),p&&(c=_?_(f):f.lng,g=y?y(f):f.lat,c&&g&&(v=u(g,c),b=v.x,m=v.y,!(0>b||b>L||0>m||m>S)))))if(x)for(var M in x){var q=x[M];if(C=q.size(f,r,n,s),l=q.sprite,C&&l&&q.filter(f)){w.pt(l,b,m,C);break}}else l=this.sprite,w.pt(l,b,m,e.switchValue(o.size,f,r,n,s))}}},clean:function(t){this.dCanvas&&this.dCanvas.clear(t)},initEventsMap:function(){this.dCanvas.onUpdate(function(){this.draw()}.bind(this))},destroy:function(){console.log("destroy...."),this.dCanvas.destroy()}});a.options={lng:e.getLng,lat:e.getLat,refreshInterval:1,size:function(){return 20},value:function(t){return t[0]||t.value},blending:"lighter",clearAlpha:1,container:"tilePane",sprite:{drawN:1.15,color:{from:"rgba(245,230,0,0.3)",to:"rgba(245,245,0,0.04)",easing:"Linear.None.1.7",space:"rgb"}}},n.ScatterCanvas=a,n.scatterCanvas=function(t){return new a(t)},module.exports=a;