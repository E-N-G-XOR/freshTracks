"use strict";var t=require("./../../leaflet"),n=require("konva"),e=require("lodash"),i=require("./../../render/leaflet_layer_konva"),a=require("./../../core/utils"),o=a.getSprite,r=a.fireEvent,s=a.switchValue,h=require("./createLinkPoints"),u=t.Layer.extend({initialize:function(t){t=this.options=a.deepMerge(u.options,t),this.dots={},this.resetVariables(),this.initAnimation()},resetVariables:function(){this.isable=!0},disable:function(){this.isable=!1,this.kLeafLayer.disable()},enable:function(){this.isable=!0,this.kLeafLayer.enable()},addTo:function(t){!this._map&&t&&(this._map=t,this.initCanvas(),this.initEventsMap(),this.initEventsShapes())},initAnimation:function(){var t=document.createElement("style");t.innerHTML="\n      @keyframes marker_wave {\n        from {\n          transform: scale(0.6);\n          opacity: 1;\n        }\n        to {\n          transform: scale(1);\n          opacity: 0;\n        }\n      }\n    ",document.head.append(t)},initEventsShapes:function(){var t,n=this,e=(this.options.hoverScale||1,this.kLeafLayer.onKonva("dragstart",function(){}).onKonva("mouseover touchstart",function(n){t=n.target,t.setAttrs({opacity:.8}),t.parent.draw()}).onKonva("mouseout",function(n){t=n.target,t.setAttrs({opacity:1}),t.parent.draw()}).onKonva("mouseout mouseup touchend",function(){setTimeout(function(){e.enableMapEvents()})}).onKonva("mousedown touchstart",this.onMouseDown.bind(this))),i=["mouseout","mousedown","mouseover","mouseout","touchstart","touchend","touchup"];i.forEach(function(t){e.onKonva(t,function(e){r(t,e,n)})})},onMouseDown:function(n){var e=this.options,i=this._map,a=n.target,o=a.__data,r=e.popup;if(r&&(r=r.bind(e)),r||(r=e.child.popup,r&&(r=r.bind(e.child))),r){var s=r(o);setTimeout(function(){if(a){var n=a.__options.top,e=i.containerPointToLatLng(t.point(n.x,n.y));i.openPopup(s,t.latLng(e.lat,e.lng))}}.bind(this)),this.kLeafLayer.disableMapEvents(n)}},initCanvas:function(){var t=this._map,e=this.options,o=t.getSize(),r=this.konvaContainer=a.createContainer(e.container),s=new n.Stage({container:r,width:o.x,height:o.y});this.kLeafLayer=new i(s,{transition:e.lazyFresh.transition,blending:e.blending,ptNPerLayer:e.ptNPerLayer});var r=window.konvaContainer=this.kLeafLayer.stage.content;r.style.pointerEvents=e.pointerEvents||"auto",this.kLeafLayer.addTo(t)},data:function(t){t&&(this._data=t,this.updateDataZindex(),this.processing())},processing:function(){var t=this._data;this.range=a.getRangePercentTile(t,this.options.value);for(var n in this.dots)this.dots[n].forEach(function(t){return t._container.remove()}),delete this.dots[n]},updateDataZindex:function(){var t=this.options,n=t.zIndex||t.child.zIndex;n&&(this._data=e.sortBy(this._data,n))},updateOptions:function(t){var n=this.kLeafLayer;n.resetOffset(),t=this.options=a.deepMerge(this.options,t),n.hideLayers(),n.updateOptions({transition:t.lazyFresh.transition,blending:t.blending,ptNPerLayer:t.ptNPerLayer}),this.draw()},updateFilter:function(t){t&&"function"==typeof t&&(this.options.filter=t,this.draw())},render:function(t){t&&this.data(t),t&&this.kLeafLayer.beginDraw(),this.draw(),t&&this.kLeafLayer.endDraw()},createShapeAttr:function(e,i){if(this.isable&&this._data&&this._data.length){var a=this.options,o=s(a.from,e),r=s(a.to,e),u=s(a.id.bind(a),e,i),d=s(a.value.bind(a),e,i),l=s(a.weight,e,d,this.range.min,this.range.max)||1,p=s(a.shadowColor,e,i),c=s(a.shadowBlur,e,i),f=s(a.color,e,i),v=this._map.latLngToContainerPoint(t.latLng(o.lat,o.lng)),g=this._map.latLngToContainerPoint(t.latLng(r.lat,r.lng)),L=a.kHeight,y=a.ptN,m=a.head,b=h(v,g,L,y,l,m),w=Math.floor(b.length/4),k={x:b[w-1],y:b[w]};return{data:e,Constructor:n.Line,index:i,id:u,top:k,attrs:{closed:!0,points:b,shadowColor:p,shadowBlur:c,fill:f}}}},draw:function(){var t=this._data;if(t&&this.isable){for(var n,e,i=this.kLeafLayer,a=this.options.filter,o=t.length-1;o>-1;o--)n=t[o],(!a||a(n,o))&&(e=this.createShapeAttr(n,o),i.addOrSetShape(e));i.stopLazyFresh(),i.lazyFresh()}},initEventsMap:function(){this._map.on("zoomend",this.draw.bind(this)).on("moveend",this.draw.bind(this))},destroy:function(){this.kLeafLayer.destroy(),this.konvaContainer.remove()},clean:function(){this.kLeafLayer.clean()}});u.options={ptN:30,zIndex:null,kHeight:.8,refreshInterval:1,ptNPerLayer:1e3,lazyFresh:{transition:"opacity 0.4s"},weight:function(){return 4},id:function(t,n){return t.id||n},color:function(){return"rgba(0,30,160,1)"},onPopupOpen:function(){},filter:function(){return!0},value:function(t){return t.count||t.value},head:{phiWeight:1,phi:Math.PI/6},marker:{background:"#ffff66",radius:80},from:a.getFrom,to:a.getTo,hoverScale:.2,blending:"lighter",container:".leaflet-overlay-pane",shadowColor:"rgba(0,155,155,0.2)",shadowBlur:60,child:{}};var d=t.dmap=t.dmap||{};d.LinkKonva=u,d.linkKonva=function(t){return new u(t)},module.exports=u;