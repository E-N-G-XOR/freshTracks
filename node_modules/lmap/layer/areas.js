"use strict";var t=require("lodash"),e=require("./../leaflet"),i=require("./../core/utils"),n=i.isNone,o=require("./../core/utils").getColorFunc,s=o({from:"#002170",to:"#c5f2e7",easing:"Quadratic.Out.1.1",space:"rgb"}),a=i.switchValue,r=e.Layer.extend({addTo:function(t){return this._map=t,this.isable=!0,this.geojson&&this.initGeojson(),this},geoJson:function(e){if(e&&!t.isEqual(e,this.geojson)){this.geojson=t.cloneDeep(e);var i=this._map;i&&(this.removeGeojson(),this.initGeojson())}},removeGeojson:function(t){t=t||this.geojsonLayer,t&&this._map.removeLayer(t)},initGeojson:function(){var t=this,i=this.options,n=this.genStyle(i.style),o=this.geojson,s=i.geoid.bind(i),a=this.layers=[],r=0,u=this.geojsonLayer=e.geoJson(o,{style:n,draggable:!1,onEachFeature:function(e,i){var n=s(e)||r++;a[n]=i,i.__feature=e,t.initEventChild(i,e)}});u.addTo(this._map),u.bringToBack(),this.initEventsPopup()},initEventChild:function(e,n){var o=this,s={feature:n,layer:e},a=this._map,r=t.filter(i.EVENTSBasic,function(t){return"mousedown1"!==t});r.forEach(function(t){e.on(t,function(){return e.__data&&(s.data=e.__data),o.fire("child-"+t,s),!0})});var u=this.options,h=u.style.hover;h&&e.on("mouseover",function(){a.closePopup(),e.setStyle&&e.setStyle(h)}).on("mouseout",function(){e.setStyle&&e.setStyle(e.__style)})},initEventsPopup:function(){var t=this,e=this._map,n=this.options.popup;this.each(function(o){o&&(t.updatePopupPostion(o),i.initEventsPopup({parent:t,child:o,map:e,datas:[o.__feature,o.__data],popup:n}))})},updatePopupPostion:function(t){var n=(this._map,i.getTopPoint(t.__feature));t.popupPosition=e.latLng(n[1],n[0])},initialize:function(e){var n=this;this.options=i.deepMerge(r.options,e),this.draw=t.debounce(function(){return n._draw()},10)},getLayer:function(t){return t&&this.layers?this.layers[t]:void 0},genStyle:function(t,e,i,n,o){var s={};for(var r in t)s[r]=a(t[r],e,i,n,o);return s},each:function(t){if(t){var e=this.layers;for(var i in e)t(e[i],i)}},data:function(t){this._data=t,this.updateRange()},updateRange:function(){this.range=i.getRangePercentTile(this._data,this.options.value)},render:function(t){t&&this.data(t),this.draw()},updateOptions:function(t){this.options=i.deepMerge(this.options,t),this.updateRange(),this.draw()},_draw:function(){var e=this;if(this.isable&&this._map){var i=void 0,n=void 0,o=this._data,s=this.options,a=s.filter,r=s.style,u=s.id.bind(s),h=s.value.bind(s),l=t.keyBy(o,u),d=void 0,c=this.range||{};this.each(function(t,o){i=l[o]||{},(!a||a(i))&&(n=h(i),d=e.genStyle(r,n,c.min,c.max),s.selectId&&o===s.selectId&&Object.assign(d,s.selectStyle),t.setStyle&&t.setStyle(d),t.__style=d,t.__data=i)}),this.initEventsPopup()}},hide:function(){var t=this;this.geojsonLayer&&this.geojsonLayer.setStyle({opacity:0,fillOpacity:0}),setTimeout(function(){t.isable=!1})},show:function(){var t=this;this.geojsonLayer&&this.geojsonLayer.setStyle({opacity:1,fillOpacity:1}),setTimeout(function(){t.isable=!0,t.draw()})},getBounds:function(){return this._map?this.geojsonLayer.getBounds():void 0},destroy:function(){this.geojsonLayer&&this._map.removeLayer(this.geojsonLayer),this._data=null}});r.options={geoid:function(t){var e=t.id||t.adcode;if(e)return e;var i=t.properties;return i?i.id||i.adcode:void 0},id:function(t,e){return t?t.id||t.adcode:e},value:function(t){return t.value},selectId:null,selectStyle:{color:"rgba(255,255,255,0.5)",zIndex:1e3},style:{zIndex:1,bubblingMouseEvents:!1,fillColor:function(t,e,i){if(!t)return"rgba(0,150,200,1)";var n=(t-e)/(i-e);return s(n)},fillOpacity:1,color:"transparent",weight:2,dashArray:null},filter:function(){return!0}};var u=e.dmap=e.dmap||{};u.Area=r,u.area=function(t){return new r(t)},module.exports=r;