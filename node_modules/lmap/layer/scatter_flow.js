"use strict";function t(t,i,e,s,o,n){this.from=a.cloneDeep(t),this.to=i,this.duration=e,this.deltaLat=(i.lat-t.lat)/e,this.deltaLng=(i.lng-t.lng)/e,this.sprite=n,this.startTime=s,this.pos=a.cloneDeep(t),this.current=0,this.size=o,this.alive=!1,this.perVec=[]}var i=require("./../leaflet"),a=require("lodash"),e=require("./../render/canvas");require("./../core/utils");var s=i.dmap=i.dmap||{},o=s.Utils,n=require("tween.js"),r=o.getSprite,p=i.Layer.extend({initialize:function(t){console.log(p),t=this.options=o.deepMerge(p.options,t),console.log(t),this.isable=!0,this.sprite=this.updateSprite(t.sprite),this.particleCount=0,this.changeFlag=!1,this.sprite2=this.updateSprite(t.sprite2),this.updateGroups(t.groups)},onDefaults:function(){var t=this.clean.bind(this),i=this.resetPos.bind(this);this._map.on("zoomstart",function(){t(1)}).on("zoomend",i).on("movestart",function(){}).on("resize",function(){t(1),i()}).on("moveend",i)},disable:function(){this.isable=!1},enable:function(){this.isable=!0},addTo:function(t){!this._map&&t&&(this._map=t,this.initCanvas(),this.initEventsMap(),this.updateBlending(),this.onDefaults())},initCanvas:function(){var t=this._map,i=this.options,a=i.container;this.dCanvas=new e(t,a,i)},data:function(t,a){a=a||{};var e=(this.map,this);this.transfer=a.transfer||function(t,a){return e._map.latLngToContainerPoint(i.latLng(t,a))},this._data?(this._data=t,this.changeFlag=!1,this.changeCount=this._data.length-1,this.dieDieDie()):(this._data=t,this.getParticle())},processing:function(){this.range=o.getRange(this._data,this.options.value)},resetPos:function(t,i){var a=this;if(void 0!==i)this.particleMap[i].map(function(t){a.resetParticle(t)});else for(var e in this.particleMap)this.particleMap[e].map(function(t){a.resetParticle(t)})},resetParticle:function(t){var i=this.transfer(t.from.lat,t.from.lng);t.from.x=i.x,t.from.y=i.y;var a=this.transfer(t.to.lat,t.to.lng);t.to.x=a.x,t.to.y=a.y;var e=this.transfer(t.pos.lat,t.pos.lng);t.pos.x=e.x,t.pos.y=e.y,t.deltaX=(t.to.x-t.from.x)/(t.duration/this.options.speed),t.deltaY=(t.to.y-t.from.y)/(t.duration/this.options.speed)},dieDieDie:function(){for(var t in this.particleMap)this.particleMap[t].map(function(t){t.todie=!0})},changeData:function(){if(100==this.options.speed&&(this.options.speed=this.lastSpeed,this.updateParticleOptions()),!(this.changeCount<0)){var i=this._data[this._data.length-1-this.changeCount],a=1e-7*i.mag_inter,e=this.options.from(i),s=this.options.to(i),n=(o.switchValue(this.options.size,i),i.length_km/a),r=e.lat+"x"+e.lng+"-"+s.lat+"x"+s.lng;if(this.particleMap[r])for(var p=0;p<i.mag_inter/200;p++)if(this.particleMap[r][p])this.particleMap[r][p].todie=!1;else{var h=this.options.from(i),l=this.options.to(i),c=n*Math.random(),d=new t(h,l,n,c,this.options.sizeValue,this.sprite);this.resetCirclePos(d,a),this.particleCount++,this.particleMap[r].push(d)}else{this.particleMap[r]=[];for(var u=0;u<i.mag_inter/200;u++){var f=this.options.from(i),g=this.options.to(i),c=n*Math.random(),d=new t(f,g,n,c,this.options.sizeValue,this.sprite);this.resetCirclePos(d,a),this.particleCount++,this.particleMap[r].push(d)}}this.resetPos({},r),this.changeCount--}},getParticle:function(){console.log("get"),this.particleMap||(this.particleMap={});var i={};for(var e in this.particleMap)i[e]=1;for(var s in this._data){{var n=this._data[s],r=1e-7*n.mag_inter,p=o.switchValue(this.options.size,n),h=n.length_km/r,l=this.options.from(n),c=this.options.to(n),d=l.lat+"x"+l.lng+"-"+c.lat+"x"+c.lng;c.lat+"x"+c.lng+"-"+l.lat+"x"+l.lng}this.particleMap[d]?this.particleMap[d].length>n.mag_inter/200?(this.particleMap[d]=a.dropRight(this.particleMap[d],this.particleMap[d].length-n.mag_inter/200),delete i[d]):delete i[d]:this.particleMap[d]=[];for(var u=0;u<=n.mag_inter/200;u++)if(!this.particleMap[d][u]){var f=this.options.from(n),g=this.options.to(n),m=h*Math.random(),v=new t(f,g,h,m,p,this.sprite);this.resetCirclePos(v,r),this.particleCount++,this.particleMap[d].push(v)}}console.log(i);for(var M in i)delete this.particleMap[M];this.resetPos()},resetCirclePos:function(t,i){var a=Math.random()*i/2;if(!t.from.x){var e=this.transfer(t.from.lat,t.from.lng);t.from.x=e.x,t.from.y=e.y;var s=this.transfer(t.to.lat,t.to.lng);t.to.x=s.x,t.to.y=s.y}var o=Math.atan((t.to.y-t.from.y)/(t.to.x-t.from.x));if(t.from.lat-t.to.lat>0){var n=Math.random()*Math.PI*6/8+Math.PI/8+o;t.perVec=[Math.cos(o+Math.PI/2),Math.sin(o+Math.PI/2)]}else{var n=Math.random()*Math.PI*-6/8-Math.PI/8+o;t.perVec=[Math.cos(o-Math.PI/2),Math.sin(o-Math.PI/2)]}var r=Math.sin(n)*a,p=Math.cos(n)*a;t.from.lat+=r,t.from.lng+=p,t.to.lat+=r,t.to.lng+=p},updateOptions:function(t){t&&(this.options=o.deepMerge(this.options,t)),this.sprite=this.updateSprite(t.sprite),this.sprite2=this.updateSprite(t.sprite2),this.updateParticleOptions(),this.updateBlending()},updateParticleOptions:function(){var t=this;for(var i in this.particleMap)this.particleMap[line].map(function(i){i.size=t.options.sizeValue;var a=i.duration/t.options.speed;i.deltaLat=(i.to.lat-i.from.lat)/a,i.deltaLng=(i.to.lng-i.from.lng)/a,i.deltaX=(i.to.x-i.from.x)/a,i.deltaY=(i.to.y-i.from.y)/a})},updateSprite:function(t){return r(t)},updateGroups:function(t){if(t)for(var i in t){var a=t[i];a.sprite&&(a.sprite=this.updateSprite(a.sprite))}},updateFilter:function(t){t&&"function"==typeof t&&(this.options.filter=t,this.draw())},updateBlending:function(t){return t?this.dCanvas.ctx.globalCompositeOperation=this.options.blending=t:void(this.dCanvas.ctx.globalCompositeOperation=this.options.blending)},updateParticle:function(t){if(this.lastTime)var i=t-this.lastTime;else var i=0;for(var a in this.particleMap)for(var e in this.particleMap[a]){var s=this.particleMap[a][e];if(s.to.lat<s.pos.lat&&s.deltaLat>0||s.to.lat>s.pos.lat&&s.deltaLat<0){if(s.todie){this.particleMap[a].splice(e,1),this.particleCount--;continue}s.pos={lat:s.from.lat,lng:s.from.lng,x:s.from.x,y:s.from.y};var o=s.duration*Math.random();s.startTime=o,s.current=0,s.alive=!1}s.current>=s.startTime&&(s.alive?(s.pos.lat=s.pos.lat+i*s.deltaLat,s.pos.lng=s.pos.lng+i*s.deltaLng,s.pos.x=s.pos.x+i*s.deltaX,s.pos.y=s.pos.y+i*s.deltaY):(s.pos.lat=s.pos.lat+(s.current-s.startTime)*s.deltaLat,s.pos.lng=s.pos.lng+(s.current-s.startTime)*s.deltaLng,s.pos.x=s.pos.x+(s.current-s.startTime)*s.deltaX,s.pos.y=s.pos.y+(s.current-s.startTime)*s.deltaY,s.alive=!0)),s.current+=i,this.lastTime=t}},render:function(t){t&&this.data(t),this.updateParticleOptions(),console.log("start"),this.animationState="play",this.animationFrame||(this.animationFrame=window.requestAnimationFrame(this.draw.bind(this)))},getCurve:function(t){if(t.to.lat<t.pos.lat&&t.deltaLat>0||t.to.lat>t.pos.lat&&t.deltaLat<0)return{x:t.pos.x,y:t.pos.y};var i=Math.abs((t.pos.lat-t.from.lat)/(t.to.lat-t.from.lat));(0>i||i>1)&&console.log(i,t);var a=30*(-i*i+i);return{x:t.pos.x+t.perVec[0]*a,y:t.pos.y+t.perVec[1]*a}},draw:function(t){this.clean();var i=(this._map,this._map.getZoom(),this.options,!0),a=this.options.filter;if(this.isable){var e,s,o=(this._data,this.sprites,this.dCanvas),n=o.w,r=o.h;for(var p in this.particleMap)for(var h in this.particleMap[p]){var l=this.particleMap[p][h];if(l&&!(l.current<l.startTime)&&(a&&(i=a(l)),i)){var c=this.getCurve(l);e=c.x,s=c.y,0>e||e>n||0>s||s>r||(l.from.lat-l.to.lat>0?o.pt(this.sprite,e,s,l.size):o.pt(this.sprite2,e,s,l.size))}}if("stop"==this.animationState)return void cancelAnimationFrame(this.animationFrame);this.particleCount<=6500&&(this.options.fade||this._map.context.renderDotLayer(),this.changeFlag=!0),this.changeFlag&&void 0!=this.changeCount&&this.changeCount>=0?(this.updateParticleOptions(),this.changeData(),this.options.fade&&this.changeData()):this.changeFlag=!1,this.updateParticle(t),window.requestAnimationFrame(this.draw.bind(this))}},clean:function(t){this.dCanvas.clear(t)},initEventsMap:function(){this.dCanvas.onUpdate(function(){}.bind(this))},destroy:function(){this.dCanvas.destroy()}});p.options={lng:o.getLng,lat:o.getLat,from:function(t){return t.from},to:function(t){return t.to},refreshInterval:1,size:function(){return 40},value:function(t){return t[0]||t.value},maxParticle:5e3,blending:"lighter",clearAlpha:1,container:"tilePane",sprite:{drawN:1.15,color:{from:"rgba(245,230,0,0.3)",to:"rgba(245,245,0,0.04)",easing:"Linear.None.1.7",space:"rgb"}},sprite2:{drawN:1.15,color:{from:"rgba(245,230,0,0.3)",to:"rgba(245,245,0,0.04)",easing:"Linear.None.1.7",space:"rgb"}}},s.ScatterFlow=p,s.scatterFlow=function(t){return new p(t)},module.exports=p;