"use strict";function i(i,t,n){return t in i?Object.defineProperty(i,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):i[t]=n,i}function t(i){i=this.options=s.deepMerge(t.options,i),this.initialize(i)}var n,e=require("./../leaflet"),s=require("./../core/utils"),a=require("./../render/canvas"),r=require("./../core/animator"),h=require("./trail_canvas_flying");t.options=(n={lineN:1e3,lifeSpeed:1,isAutoUpdate:!0,type:"flying",isable:!0,container:"#canvas",id:function(i){return i.id}},i(n,"id",s.getID),i(n,"lifeMin",0),i(n,"lifeMax",1e11),i(n,"child",{spriteFlying:{type:"linear",isContinue:!0,width:200,height:20,color:{from:"rgba(233,0,0,0.3)",to:"#f2f7b8",space:"hsl",easing:"linear.Out.3"}},spriteHead:{type:"radian",isContinue:!1,width:100,height:100,color:{to:"rgba(255,150,0,0.4)",from:"rgba(255,150,0,0.4)",space:"hsl",easing:"linear.Out.1"}},size:function(){return 6},delay:2,lengthLimit:60,lineSegmentLonger:0,isAutoUpdate:!1,isable:!0,blending:"lighter",type:"line",ptsN:25,weight:function(i,t){return 5*Math.pow(t,3)},value:function(i){return Math.min(1,i.length/40)},lng:s.getLng,lat:s.getLat,time:s.getTime,pts:function(i){return i.pts}}),n);var t=r.extend(t,{events:{},initialize:function(i){this.isable=!0,this.lifeMax=i.lifeMax,this.lifeMin=i.lifeMin,this.life=this.lifeMin,i.isAutoUpdate&&this.initEventsAnim()},initCanvas:function(){var i=this.options,t=i.child,n=t.blending||i.blending;this.lcanvas=new a(this._map,i.container,{clearAlpha:1});var e=this.ctx=this.lcanvas.ctx;e.globalCompositeOperation=n,t.ctx=e},addTo:function(i){!this._map&&i&&(this._map=i,this.initCanvas(),this.initTrails(),this.initEventsMap(),this._data&&this.updateZoom())},clear:function(){var i,t=this.using,n=this.unusing;for(var e in t)i=t[e],i.reset();this.using={},n=[];var s=this.trails;for(var a in s)n.push(s[a]);this.unusing=n},reset:function(){var i=this.unusing=[];this.using={};var t=this.trails;for(var n in t){var e=t[n];e.stop&&e.stop(),e.pause&&e.pause(),e.resetVariables()}this.life=this.options.lifeMin;var t=this.trails;for(var s in t)i.push(t[s]);this.resume()},initCacheColor:function(){},mergeData:function(i){for(var t,n=this.options,e=n.id.bind(n),s=i.d,a=this._data=this._data||{},r=0;r<i.length;r++)s=i[r],t=e(s),a[t]?a[t].pts.push(s):a[t]={pts:[s],id:t};this.resetOrUpdateTrails(),this.options.isAutoUpdate&&this._map&&!this.loopid&&this.startAnim()},data:function(i){if(!i)return this._data;var t=this.unusing,n=this.using;if(t&&t.length){var e=t.pop(),s=this.options,a=s.child.pts,r=a(i);e.updateOptions({lifeMin:0,lifeMax:r.length}),e.data(i),n[e.id]=e,this.options.isAutoUpdate&&this._map&&!this.loopid&&this.startAnim()}},resetOrUpdateTrails:function(){var i,t,n,e=this._data,s=this.using,a=this.unusing,r=this.options,h=r.child.pts.bind(r.child);for(var o in e)i=e[o],t=s[o],n=h(i),t?t.processing():(t=a.pop(),n&&n.length>3&&(t.data(i),t.id=o,s[o]=t))},datas:function(i){if(!i)return this._data;this._data=i;for(var t in i)this.data(i[t])},initTrails:function(){var i=this.options,t=i.child;t.lifeSpeed=i.lifeSpeed,t.isable=i.isable,t.container=i.container,this.using={};for(var n,e=this.unusing=[],s=this._map,a=this.trails=[],r=i.lineN,o=0;r>o;o++)n=new h(t),n.addTo(s),this.initEventsTrail(n),a.push(n),e.push(n)},each:function(i){var t=this.using;for(var n in t)i(t[n],n)},checkTrail:function(i){if(i.isEnd()){var t=this.using,n=!1;for(var e in t)if(t[e].equalTo(i)){n=!0,delete t[e];break}n&&this.unusing.push(i)}},initEventsTrail:function(i){var t=this;i.on("lifeEnd",function(){t.emit("flying-end",i._data)})},updateOptions:function(i){i=this.options=s.deepMerge(this.options,i,!0);var t=i.child;t.lifeSpeed=i.lifeSpeed;this.trails;this.each(function(i){i.updateOptions(t)})},render:function(i,t){t=t||"group","group"===t?this.datas(i):"flatten"===t&&this.mergeData(i)},updateAnim:function(i){if(this.isable){if(this.iii=this.iii||0,this.lcanvas.clear(),i=i||this.life,i+=this.options.lifeSpeed,i>this.options.lifeMax)return this.life=this.options.lifeMax,this.disable();var t=this.using;for(var n in t){var e=t[n];e.life=i,e.updateAnim(i),this.checkTrail(e)}}},updateMap:function(){if(this.isable){var i=this.ctx;i&&i.clearRect(0,0,i.canvas.width,i.canvas.height);var t=this._map.getBounds(),n=this.using;for(var e in n){var s=n[e];s&&s.updateMap(t)}}},clean:function(){var i=this.ctx;i&&i.clearRect(0,0,i.canvas.width,i.canvas.height)},enable:function(){this.isable=!0,this.resume(),this.updateMap()},disable:function(){this.clean(),this.pause(),this.isable=!1},initEventsMap:function(){var i=this;this._map.on("movestart",function(){}).on("moveend",function(){i.updateMap()}.bind(this))},select:function(i){var t,n,e=this.trails;this.clean();for(var s=0;s<e.length;s++)t=e[s],n=t.id,i&&n in i?(t.enable(),t.updateBgLine()):t.disable()},hide:function(i){this.each(function(t){i(t,t._data)&&t.hide()})},unselect:function(){var i,t=this.trails;this.clean();for(var n=0;n<t.length;n++)i=t[n],i&&i.enable()},initEventsAnim:function(){this.on("update",function(i){this.updateAnim(i)})}}),o=e.dmap=e.dmap||{};o.TrailsCanvas=t,o.trailsCanvas=function(i){return new t(i)},module.exports=t;