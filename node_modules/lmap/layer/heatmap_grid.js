"use strict";var t=require("./../leaflet"),i=require("@ali/map-utils"),e=i.Grid,r=i.getColorFunc,a=t.Layer.extend({lines:[{id:"format"},{id:"bind"},{id:"events"}],nodes:{data:{schema:{shapeHash:{type:"string",desc:"类似geohash 对形态的编码"}}},shape:{pts:["lat","lng"]}},emits:{"grid-resize":{desc:"格子大小发生变化"},"grid-mouseover":{desc:"鼠标移至格子范围"},"grid-dblclick":{desc:"双击格子"},"grid-mouseout":{desc:"鼠标移出格子范围"},"grid-click":{desc:"点击某个格子"}},options:{clusterStepByZoom:1,isAutoUpdate:!0,isNeedAggregate:!0,grid:{mouseover:{fillOpacity:.8,color:"rgba(255,255,255,0.9)"},mouseout:{fillOpacity:1,color:"rgba(255,255,255,0.0)"},click:{},weight:1,color:"rgba(255,255,255,0)",fillOpacity:1,rx:30,ry:25},getColor:r("rgba(62,18,0,0.8)","rgba(255,208,122,0.8)","hsl","linear.Out.1.4"),lng:i.getLng,lat:i.getLat,scale:function(){return 1},value:function(t,i){return Math.min(1,t.length/i)}},gridMap:{},aggregatedData:{},initialize:function(t){t=i.deepMerge(this.options,t),this.getMax=t.getMax,this.getColor=i.getColorFunc(t.getColor),this.getScale=i.getColorFunc(t.scale)},addTo:function(i){if(!this._map&&i){this._map=i;var r=this.options.grid;this.gridEncoder=(new e).transform(function(e,r){var a=i.getSize(),n=a.x/2,o=a.y/2,s=n-e,d=o+r,g=n+e,l=o-r,u=i.containerPointToLatLng(t.point(s,d)),c=i.containerPointToLatLng(t.point(g,l));return{dlat:c.lat-u.lat,dlng:c.lng-u.lng}}).shape("rect").rx(r.rx).ry(r.ry).update(),this.initEventsMap(),this._data&&this.updateZoom()}},data:function(t){if(!t)return this._data;this._data=t;var i=this.options;i.isAutoUpdate&&this._map&&this.updateZoom(),this.updateColor()},initEventsMap:function(){var t=this;this._map.on("moveend",function(){this.render()}.bind(this)).on("zoomend",function(){t.updateZoom()})},updateZoom:function(){var t=this.options,i=t.clusterStepByZoom,e=this._map;if(t.isNeedAggregate){var r=e.getZoom(),a=Math.floor(r/i);if(a===this.zoomLevel)return;this.gridEncoder.update(),this.zoomLevel=a,this.clean(),this.aggregate(),this.fire("grid-resize"),this._updateTransformOrigin()}else;},aggregate:function(){var t,i,e,r=this.gridEncoder,a=this.options,n=this.aggregatedData,o=this._data,s=a.lat,d=a.lng;for(var g in o)e=o[g],i=r.encode(s(e),d(e)),t=n[i],t?t.push(e):n[i]=[e]},getBounds:function(){var t=this._map.getBounds(),i=t._southWest,e=t._northEast,r=.5*(e.lat-i.lat),a=.5*(e.lng-i.lng);return{latMin:i.lat-r,latMax:e.lat+r,lngMin:i.lng-a,lngMax:e.lng+a}},clean:function(){var t=this.gridMap,i=this._map;for(var e in t){var r=t[e];i.removeLayer(r),delete t[e]}this.aggregatedData={}},remove:function(){this.clean()},link:function(){},updateColor:function(t,e,r,a){if(t){var n,o,s=this.getColor=i.getColorFunc(t,e,r,a),d=this.gridMap;for(var g in d)n=d[g],o=n._value,n.setStyle({fillColor:s(o)})}},updateScale:function(t){t&&(this.scaleGridFunc=function(i,e){if(i){var r=i._container;this._updateTranformOriginGird(r);var a=t(e),n="scale3d("+a+","+a+",1)";r.style.transform=n,r.style["-webkit-transform"]=n,this.getScale=t}})},_updateTranformOriginGird:function(t){if(t){var i=t.getBBox(),e=i.width/2+i.x+"px "+(i.height/2+i.y)+"px 0px";t.style["transform-origin"]=e,t.style["-webkit-transform-origin"]=e}},_updateTransformOrigin:function(){if(this.scaleGridFunc){var t=this.gridMap,i=this;setTimeout(function(){for(var e in t)i._updateTranformOriginGird(t[e]._container)})}},render:function(t){t&&this.data(t),this.draw()},draw:function(){var i,e=this.options,r=this.gridEncoder,a=e.grid,n=this.getColor,o=e.value,s=this.aggregatedData,d=this.gridMap,g=this._map,l=this.getBounds(),u=l.latMax,c=l.latMin,h=l.lngMax,f=l.lngMin,p=40;for(var m in s){var v=s[m],_=r.decode(m),y=_.center,M=_.pts,x=y[0],b=y[1];if(!(c>x||f>b||x>u||b>h)){var C=o(v,p,0);if(!d[m]){if(a.fillColor=n(C),i=d[m]=t.polygon(M,a).addTo(g),i._value=C,i._gridid=m,this.initEventsGrid(i),!this.scaleGridFunc)continue;this.scaleGridFunc(i,C)}}}},initEventsGrid:function(t){var i=this,e=this.aggregatedData,r=this.options.grid,a=r.click||{},n=r.mouseover||{},o=r.mouseout||{},s=t._gridid,d={gridid:s,data:e[s]};t.on("mouseover",function(){n&&t.setStyle(n),i.fire("grid-mouseover",d),t.bringToFront()}).on("mouseout",function(){o&&t.setStyle(o),i.fire("grid-mouseout",d)}).on("mousedown",function(){a&&t.setStyle(a),i.fire("grid-click",d)}).on("dblclick",function(){i.fire("grid-dblclick",d)})}}),n=t.dmap=t.dmap||{};n.HeatmapGrid=a,n.heatmapGrid=function(t){return a(t)},module.exports=a;