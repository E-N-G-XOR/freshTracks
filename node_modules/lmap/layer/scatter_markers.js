"use strict";function t(i){i=this.options=n.deepMerge(t.options,i),this.getChildOptions(),this.initialize(i)}var i=require("./../leaflet"),n=require("./../core/utils"),e=n.EVENTS,a=require("bcore/event"),s=require("./scatter_marker"),o=i.dmap=i.dmap||{};t.options={lat:n.getLat,lng:n.getLng,filter:function(){return!0},popupText:"loading...",range:[0,1],id:function(t,i){return t.id||i},text:function(t){return t.text},value:function(t){return t.value||t.num||t[0]},zoom:{max:18,min:3},child:{size:function(){return 15},shape:{normal:{}}}},t=a.extend(t,{initialize:function(){this.cache={},this.isable=!0},addTo:function(t){t&&(this._map=t,this.initEventsMap(),this.initPopUp())},initPopUp:function(){var t=this._map;t||(t._popup=i.popup("..."))},data:function(t){this._data=t},clean:function(){var t,i,n=this.cache;if(n)for(var e in n)t=n[e],i=t.visual,i&&i.destroy&&(i.destroy(),delete t.visual)},updateData:function(t){this.processing(t),this.cleanOld()},updateFilter:function(t){"function"==typeof t&&(this.options.filter=t,this.updateMap())},cleanOld:function(){var t,i,n,e=this.versionID,a=this.cache;if(e&&a)for(var s in a)t=a[s],n=t.versionID,n!==e&&(i=t.visual,i&&(i.off&&i.off(),i.destroy&&i.destroy()),delete a[s])},processing:function(t){var i=this.versionID=Math.random(),n=this._map;if(n){var e,a,o,r,p,u,h,d,c=this.options,f=this.getChildOptions(),l=this.isInZoom(),v=this._map.getZoom(),g=c.id,m=c.lat,_=c.lng,b=c.filter,E=c.groups,O=this.cache,I=this.isable;for(var x in t){if(e=t[x],c.processing&&c.processing(e),a=g(e,x),o=m(e),r=_(e),p=O[a],h=!0,h=b(e,v),d=!0,E){d=!1;for(var x in E){var M=E[x];if(M.filter(e)){d=!0;break}}}if(p?p.data=e:p=O[a]={data:e},p.versionID=i,l&&h&&d&&this.isInView(o,r)&&I){var u=p.visual;u?u.updateData(e):I&&(u=p.visual=new s(f),u.addTo(n),u.render(e),this.initEventsScatter(u))}}this.updateRange()}},render:function(t){t&&this.data(t),t=this._data,this.updateData(t)},enable:function(){this.isable=!0},disable:function(){this.isable=!1},isInZoom:function(){var t=this.options.zoom;if(!t)return!0;var i=this._map,n=t.max,e=t.min,a=i.getZoom();return a>n||e>a?!1:!0},isInView:function(t,i,n){n=n||this._map.getBounds();var e=n._northEast.lng,a=n._northEast.lat,s=n._southWest.lng,o=n._southWest.lat;return a>t&&t>o&&e>i&&i>s},each:function(t){var i=this.cache;for(var n in i)t.bind(this)(i[n])},getOptionsValue:function(t){var i=this.options;return i.child[t]||i[t]},getChildOptions:function(){var t={},i=this;return["id","text","lat","lng","range","value","css","popupText","popup"].forEach(function(n){t[n]=i.options[n]=this.getOptionsValue(n)}.bind(this)),t},updateOptions:function(t){t=this.options=n.deepMerge(this.options,t);var i,e=this.getChildOptions(),a=this,s=t.popup;this.each(function(t){var n=t.visual;n&&(a._bindPopup(n),n.updateOptions(e),i=n.popupGroup,i&&i.updateOptions&&i.updateOptions(s))}),this.draw()},draw:function(){{var t,i,n,e,a,o,r,p,u=this.options,h=this.cache,d=u.lng,c=u.lat,f=u.filter,l=this._map.getZoom(),v=this.isInZoom();u.groups}if(!v)return this.clean();if(h&&this.isable){var g=this.getChildOptions(),m=this._map;for(var _ in h)t=h[_],a=t.data,n=c(a),e=d(a),p=this.isInView(n,e),o=!0,o=f(a,l),r=!0,o=o&&r,i=t.visual,p&&o?i?(i.updateData(a),i.updateZIndex()):(i=t.visual=new s(g),i.addTo(m),i.render(a),this.initEventsScatter(i)):i&&(i.off&&i.off(),i.destroy&&i.destroy(),delete t.visual)}},updateMap:function(){this.draw()},updateRange:function(){var t=this.cache,i=this.ranges=this.ranges||{},n=this.options.value,e=i.value=[];for(var a in t){var s=t[a].data,o=n(s);e[0]||(e=[o,o]),o<e[0]&&(e[0]=o),o>e[1]&&(e[1]=o)}},_bindPopup:function(t){n.initEventsPopup({parent:this,child:t,map:this._map,datas:[t._data],popup:this.options.popup})},initEventsPopup:function(t){var i=this._map;this._bindPopup(t),i.on("zoomend",function(){t.updatePopupPostion()}.bind(this))},initEventsMap:function(){this._map.on("moveend",this.updateMap.bind(this))},initEventsScatter:function(t){var i=this;e.forEach(function(n){t.on(n,function(t){i.emit("child-"+n,t)})}),this.initEventsPopup(t)},destroy:function(){this.clean(),this.cache={}}}),o.ScatterMarkers=t,o.scatterMarkers=function(i){return new t(i)},module.exports=t;