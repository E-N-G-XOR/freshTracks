"use strict";function i(t){t=this.options=s.deepMerge(i.options,t),t.interactiveLine.kHeight=t.kHeight,t.displayLine.kHeight=t.kHeight,this.initialize(t)}function t(i){if("string"==typeof i&&-1!==i.indexOf(",")){i=i.split(",");var t=i[0]||0,e=i[1]||0;return{lat:parseFloat(t,10),lng:parseFloat(e,10)}}return i}var e=require("./../leaflet"),n=require("./flyingLinePath"),s=require("./../core/utils"),o=e.dmap=e.dmap||{},a=require("./../core/anim_view");i.options={isAutoStart:!1,lifeMin:0,lifeMax:1,isPopupHover:0,lifeEnd:"destroy",range:.8,lifeSpeed:.08,kHeight:.5,interactiveLine:{weight:5,color:"rgba(250,150,50,0.0)",colorHover:"rgba(250,150,50,0.1)"},displayLine:{weight:1}},i.options=s.deepMerge(a.options,i.options),i=a.extend(i,{isInit:!1,life:0,initialize:function(){this._map&&this.addTo(this._map),this.id=this.options.id||s.getId("flyingLine"),this.isLive=!1,this.isLooping=!0},checkIfEnd:function(){this.life>=this.options.lifeMax+this.options.range&&this._onLifeEnd()},addTo:function(i){return this._map=i,this.init(),this.initEvents(),this},init:function(){!this.isInit&&this._map&&(this.initInteractiveLine(),this.initDisplayLine(),this.isInit=!0)},initDisplayLine:function(){throw"必须实现initDisplayLine方法"},initInteractiveLine:function(){var i=this.options,t=this._map,e=this,s=i.interactiveLine;if(s.kHeight=i.kHeight,s){var o=this.interactivePath=new n(s);o.addTo(t);var a=o._path;a.setAttribute("fill","none"),a.setAttribute("stroke",s.color),a.setAttribute("stroke-width",s.weight),a.setAttribute("stroke-linecap","round"),a.setAttribute("stroke-linejoin","round"),o.on("mouseover",function(){a.setAttribute("stroke",s.colorHover),e.emit("mouseover",e.record),i.isPopupHover&&o.openPopup()}).on("mouseout",function(){a.setAttribute("stroke",s.color),i.isPopupHover&&o.closePopup(),e.emit("mouseout",e.record)}).on("mousedown",function(){e.resume(),e.fireEvent("mouseout",o),e.emit("mousedown",e.record)}).on("click",function(){e.emit("click",e.record)})}},setPopupContent:function(i){this.interactivePath&&this.interactivePath.setPopupContent(i)},data:function(i){return i&&i.from&&i.to?(i.from=t(i.from),i.to=t(i.to),this._data=i,this.updateData(i),this.bindPopup(),this.reset(),this.options.isAutoStart&&this.resume(),void(this.record={data:i,layer:this})):console.log("无数据/数据格式有问题")},render:function(i){i&&this.data(i),this.draw()},draw:function(){this.fireEvent("lifestart",{latlng:this.displayPath.from,data:this._data}),this.startAnim()},initEvents:function(){this.on("update",this.updateLife.bind(this)).on("lifeEnd",function(){var i=this.options.lifeEnd;return"loop"===i?this.restart():"hide"===i?this.hide():"destroy"===i?this.destroy():void 0})},updateOptions:function(i){i=this.options=s.deepMerge(this.options,i),this.updateOptionsInteractiveLine&&this.updateOptionsInteractiveLine(),this.updateOptionsDisplayLine&&this.updateOptionsDisplayLine(),i.interactiveLine.kHeight=i.kHeight,this.interactivePath&&this.interactivePath.updateOptions(i.interactiveLine),i.displayLine.kHeight=i.kHeight,this.displayPath&&this.displayPath.updateOptions(i.displayLine)},updateLife:function(i){this.isLive&&(this.updateInteractiveLine&&this.updateInteractiveLine(i),this.updateDisplayLine&&this.updateDisplayLine(i))},updateData:function(i){this.interactivePath&&this.interactivePath.data(i),this.displayPath&&this.displayPath.data(i)},bindPopup:function(i,t){if(i=i||this.bindHTML){if(!this._data)return this.bindHTML=i;t=s.deepMerge({maxWidth:800,autoPan:!1},t),"function"==typeof i&&(i=i(this._data||{})),this.interactivePath.bindPopup(i,t),this.bindHTML=null}},hide:function(){this.life=0,this.isLive=!1,this.interactivePath&&this.interactivePath.hide(),this.displayPath&&this.displayPath.hide(),this.fire("hide")},pause:function(){this.isLooping=!1,this.isLive=!1,cancelAnimationFrame(this.loopid),this.loopid=null,this.fire("pause")},resume:function(){if(!this.isLive){{this.options}setTimeout(function(){}.bind(this)),this.isLive=!0,this.loop(),this.fire("resume")}},loop:function(){this.isLooping&&(this._updateLife(),this.loopid=requestAnimationFrame(this.loop.bind(this)))},isEnd:function(){return this.life>this.options.lifeMax},reset:function(){var i=this.options;this.life=i.lifeMin},destroy:function(){this.pause(),this.off(),this.life=0,this.isLive=!1,this.interactivePath&&this.interactivePath.destroy(),this.displayPath&&this.displayPath.destroy()}}),o.FlyingLine=i,o.flyingLine=function(t){return new i(t)},module.exports=i;