"use strict";function t(t){this.initialize(t)}var e=require("bcore/event"),i=require("./../core/utils"),n=require("./../render/leaflet_layer_konva"),a=require("konva"),o=require("./../leaflet"),s=require("lodash"),r=i.fireEvent,h=i.switchValue;t.options={ptNPerLayer:2e3,lazyFresh:{transition:"opacity 0.4s"},blending:"lighter",lng:i.getLng,lat:i.getLat,id:function(t,e){return t.id||e},radius:10,angle:10,rotation:0,stroke:"transparent",strokeWidth:0,fill:"rgba(0,190,190,0.2)",hoverScale:1.2,zIndex:function(t){return-t.value}},t=e.extend(t,{addTo:function(t){this._map=t,this.initCanvas(),this.initEventsMap(),this.initEventsShapes()},initialize:function(e){e=this.options=i.deepMerge(t.options,e),this.resetVariables()},resetVariables:function(){this.isable=!0},disable:function(){this.isable=!1,this.kLeafLayer.disable()},enable:function(){this.isable=!0,this.kLeafLayer.enable()},initCanvas:function(){var t=this._map,e=this.options,i=t.getSize(),o=new a.Stage({container:e.container,width:i.x,height:i.y}),s=this.kLeafLayer=new n(o,{transition:e.lazyFresh.transition,blending:e.blending,ptNPerLayer:e.ptNPerLayer});s.addTo(t)},data:function(t){this._data=t;var e=this.options,i=e.zIndex||e.child.zIndex;i&&(this._data=s.sortBy(t,i))},createShapeAttr:function(t,e){if(this.isable){var i=this.options,n=this._map.getZoom(),s=h(i.lat,t),r=h(i.lng,t),u=h(i.id.bind(i),t,e),d=h(i.radius,t,n)||1,l=h(i.angle,t,n)||1,p=h(i.rotation,t,n),c=h(i.fill,t,n),f=h(i.stroke,t,n),v=h(i.strokeWidth,t,n),g=this._map.latLngToContainerPoint(o.latLng(s,r));return{data:t,Constructor:a.Wedge,index:e,id:u,attrs:{x:g.x,y:g.y,radius:d,rotation:p,angle:l,stroke:f,strokeWidth:v,fill:c}}}},draw:function(){var t=this._data;if(t&&this.isable){for(var e,i,n=this.kLeafLayer,a=this.options.filter,o=t.length-1;o>-1;o--)e=t[o],(!a||a(e,o))&&(i=this.createShapeAttr(e,o),n.addOrSetShape(i));n.stopLazyFresh(),n.lazyFresh()}},render:function(t){t&&this.data(t),t&&this.kLeafLayer.beginDraw(),this.draw(),t&&this.kLeafLayer.endDraw()},initEventsMap:function(){this._map.on("zoomend",this.draw.bind(this)).on("moveend",this.draw.bind(this))},onMouseDown:function(t){var e=this.options,i=this._map,n=t.target,a=n.__data,s=e.popup;s&&(s=s.bind(e)),s||(s=e.child.popup,s&&(s=s.bind(e.child))),s&&(popupText=s(a),setTimeout(function(){var t=n.getClientRect(),e=t.x+t.width/2,a=t.y+t.height/2,s=i.containerPointToLatLng(o.point(e,a));i.openPopup(popupText,o.latLng(s.lat,s.lng))}.bind(this)),this.kLeafLayer.disableMapEvents())},initEventsShapes:function(){var t,e=this,i=this.options.hoverScale||1,n=this.kLeafLayer.onKonva("mouseover touchstart",function(e){t=e.target,t.setAttrs({scale:{x:i,y:i}}),t.parent.draw()}).onKonva("mouseout",function(e){t=e.target,t.setAttrs({scale:{x:1,y:1}}),t.parent.draw()}).onKonva("mouseout mouseup touchend",function(){setTimeout(function(){n.enableMapEvents()})}).onKonva("mousedown touchstart",this.onMouseDown.bind(this)),a=["mouseout","mousedown","mouseover","mouseout","touchstart","touchend","touchup"];a.forEach(function(t){n.onKonva(t,function(i){r(t,i,e)})})}}),module.exports=t;