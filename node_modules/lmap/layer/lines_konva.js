"use strict";function t(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function e(t){t=this.options=s.deepMerge(e.options,t)}function n(t){return!t[0][0][0]}function i(t){return t.type&&-1!==t.type.toLowerCase().indexOf("feature")||t.features}var o,a=require("./../leaflet"),r=require("bcore/event"),s=require("./../core/utils"),u=s.isNone,h=s.fireEvent,c=require("konva"),f=a.dmap=a.dmap||{},d=require("./../render/leaflet_layer_konva"),p=s.getColorFunc({from:"rgba(245,230,0,1)",to:"rgba(205,0,0, 0.6)",none:"rgba(200,200,200, 0.6)",easing:"Linear.None.1.7",space:"rgb"});e.options=(o={container:".leaflet-overlay-pane",value:function(t){return t.value},lazyFresh:{transition:"opacity 0.1s"},popup:function(){return"test"},blending:"source-over",color:function(t,e,n){if(!t)return p(null);var i=(t.value-e)/(n-e);return p(i)},id:function(t,e){return t.id||t[0]||e},style:{stroke:"#fff",strokeWidth:2,lineCap:"round",lineJoin:"round"}},t(o,"value",function(t){return t.value}),t(o,"geoId",function(t,e){return t.properties?t.properties.id||e:t.id||e}),t(o,"lat",s.getLat),t(o,"lng",s.getLng),o),e=r.extend(e,{initCanvas:function(){var t=this._map,e=this.options,n=s.createContainer(e.container),i=t.getSize(),o=new c.Stage({container:n,width:i.x,height:i.y}),a=this.kLeafLayer=new d(o,{transition:e.lazyFresh.transition,blending:e.blending,ptNPerLayer:e.ptNPerLayer});a.addTo(t)},addTo:function(t){return t?(t._map&&(t=t._map),this._map=t,this.isable=!0,this.initCanvas(),this.initEvents(),this.initEventsMap(),this):void 0},geojson:function(t){return t?(this._geodata=t,this.processGeoData(t),void this.draw()):console.log("地理数据缺失")},processGeoData:function(t){var e,n=this.features={},o=this.options,a=o.geoId,r=o.lng,s=o.lat;if(i(t)){var u=t.features;u.forEach(function(t,i){e=a(t,i),n[e]=t})}else t.forEach(function(t){var i=t.latlngs||t.coords||t.coordinates,o=[];i.forEach(function(t){o.push([r(t),s(t)])}),e=a(t),n[e]={type:"feature",geometry:{type:"LineString",coordinates:o}}})},draw:function(){var t,e,i,o=this,a=this.dataObj||{},r=this.features,s=this.layers={};this.lineIndex=0;for(var u in r){t=r[u].geometry,e=t.coordinates,i=a[u];var h=(s[u]=[],0);n(e)?this.createLineAttr(e,u,h,i):e.forEach(function(t){return Array.isArray(t[0])?(h++,o.createLineAttr(t,u,h,i)):void t.forEach(function(t){h++,o.createLineAttr(t,u,h,i)})})}this.kLeafLayer.stopLazyFresh(),this.kLeafLayer.lazyFresh()},createLineAttr:function(t,e,n,i){if(this.isable){this.lineIndex+=1;var o=this.getChildOptions(),r=s.switchValue(this.options.weight,i)||1;o.strokeWidth=r;var u=this._map.latLngToContainerPoint.bind(this._map),h=this.range||[],f=(o.stroke=s.switchValue(this.options.color,i,h[0],h[1]),o.points=[]);t.forEach(function(t){var e=u(a.latLng(t[1],t[0]));f.push(e.x,e.y)});var d=Math.floor(f.length/4),p={x:f[2*d],y:f[2*d+1]};this.kLeafLayer.addOrSetShape({data:i,top:p,Constructor:c.Line,index:this.lineIndex,id:e+"-"+n,attrs:o})}},getChildOptions:function(){var t=this.options;return t.style},updateRange:function(){var t,e,n,i,o=this._data,a=this.options,r=a.value,s=a.filter,h=this.range=[];for(var c in o)t=o[c],e=r(t),u(e)||(!s||s(t))&&("number"!=typeof e&&(e=parseFloat(e)),u(h[0])&&(h[0]=h[1]=e),n=h[0],i=h[1],e>i&&(h[1]=e),n>e&&(h[0]=e))},initEventsMap:function(){this._map.on("zoomend",this.draw.bind(this)).on("moveend",this.draw.bind(this))},initEvents:function(){var t,e=this,n=this.kLeafLayer.onKonva("dragstart",function(){}).onKonva("mouseover touchstart",function(e){t=e.target,t.setAttrs({opacity:.8}),t.parent.draw()}).onKonva("mouseout",function(e){t=e.target,t.setAttrs({opacity:1}),t.parent.draw()}).onKonva("mouseout mouseup touchend",function(){setTimeout(function(){n.enableMapEvents()})}).onKonva("mousedown touchstart",this.onMouseDown.bind(this)),i=["mouseout","mousedown","mouseover","mouseout","touchstart","touchend","touchup"];i.forEach(function(t){n.onKonva(t,function(n){h(t,n,e)})})},onMouseDown:function(t){var e=this.options,n=this._map,i=t.target,o=i.__data,r=e.popup;if(r&&(r=r.bind(e)),r||(r=e.popup,r&&(r=r.bind(e))),r){var s=r(o);setTimeout(function(){if(i){var t=i.__options.top,e=n.containerPointToLatLng(a.point(t.x,t.y));n.openPopup(s,a.latLng(e.lat,e.lng))}}.bind(this)),this.kLeafLayer.disableMapEvents()}},each:function(){},destroy:function(){this.kLeafLayer.destroy(),this.konvaContainer.remove()},data:function(t){return t?(this._data=t,this.processing(t),void this.updateRange()):console.log("没数据...")},processing:function(t){var e,n,i=this.options.id,o=this.dataObj={};for(var a in t)e=t[a],n=i(e),o[n]=e},render:function(t){t&&this.data(t),this.draw()},disable:function(){this.isable=!1,this.kLeafLayer.disable()},enable:function(){this.isable=!0,this.kLeafLayer.enable()},update:function(){this.updateLife()},updateOptions:function(t){this.options=s.deepMerge(this.options,t),this.draw()},remove:function(){}}),f.LinesKonva=e,f.linesKonva=function(t){return new e(t)},module.exports=e;