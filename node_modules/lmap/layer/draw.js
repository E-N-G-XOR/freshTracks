"use strict";function t(){return(new Date).getTime()/1e3}function i(t){return t&&t.touches&&t.touches.length>1}var n=require("./../leaflet"),o=require("./../core/utils"),e=o.isNone,s=require("./../core/utils").getColorFunc,r=require("turf-distance"),a=require("turf-line-distance"),l=require("turf-simplify"),u=n.Layer.extend({initialize:function(t){this.options=o.deepMerge(u.options,t)},addTo:function(t){return this._map=t,this.initEvents(),this},initEvents:function(){var t=this._map,i=t._container;n.Browser.touch?(n.DomEvent.on(i,"touchstart",this.onMousedown,this),n.DomEvent.on(i,"touchmove",this.onMousemove,this),n.DomEvent.on(i,"touchend",this.onMouseup,this)):t.on("mousedown",this.onMousedown.bind(this)).on("mousemove",this.onMousemove.bind(this)).on("mouseup",this.onMouseup.bind(this))},getLatlng:function(t){var i=t.touches[0],n=this._map,o=n.mouseEventToContainerPoint({clientX:i.clientX,clientY:i.clientY}),e=n.containerPointToLayerPoint(o);return n.layerPointToLatLng(e)},onMousedown:function(n){if(this.isable&&!i(n)){this.fire("draw-start"),this.isdown=!0;var o=n.latlng||this.getLatlng(n);this.latlngs=[o],this.curT=t()}},onMousemove:function(t){if(this.isable&&this.isdown&&!i(t)){var o=t.latlng||this.getLatlng(t);this.latlngs.push(o),this.curCurve?this.curCurve.setLatLngs(this.latlngs):this.curCurve=n.polyline(this.latlngs,this.options.editing).addTo(this._map)}},onMouseup:function(t){this.isdown=!1,this.isable&&!i(t)&&this.finalize(this.curCurve)},finalize:function(t){var i=this.options;if(!t&&i.point.isable){var o=this.latlngs[0];if(!o)return;var e=i.point.normal,s=n.circleMarker(o,e).addTo(this._map);return s.setRadius(e.radius||e.r),void s.on("mousedown",function(t){return n.DomEvent.stopPropagation(t),!1})}var r=this.getFactor(),a=t.toGeoJSON(),u=this.isPolygon(a),h=l(a,r,!0);i.printAfterMouseDown&&console.log(JSON.stringify(h)),this.fire("draw-end",{data:h});var a=n.geoJson(h,{style:u?i.polygon.normal:i.polyline.normal}).addTo(this._map);this.latlngs=[],this._map.removeLayer(this.curCurve),this.curCurve=null},isPolygon:function(t){var i,o=a(t,"meters"),e=t.geometry.coordinates,s=e[0],r=e[e.length-1];return i=n.latLng(s[1],s[0]).distanceTo(n.latLng(r[1],r[0])),i/o<this.options.polygonK?(e.push(s),!0):!1},getFactor:function(){var t=this.options.digits,i=this._map,n=i.getCenter(),o=i.latLngToContainerPoint(n),e=o.clone();e.x=e.x+t;var s=i.containerPointToLatLng(e);return s.lng-n.lng},enable:function(){this.isable=!0,this.disableMap()},disable:function(){this.isable=!1,this.enableMap()},"switch":function(){return this.isable?this.disable():this.enable()},enableMap:function(){var t=this._map;t&&t.dragging.enable()},disableMap:function(){var t=this._map;t&&t.dragging.disable()}});u.options={digits:4,polygonK:.1,printAfterMouseDown:!1,editing:{dashArray:"2,9",weight:2,opacity:.8,color:"#f00"},polyline:{isable:!0,normal:{weight:5,opacity:1,color:"#0ff"}},polygon:{isable:!0,normal:{weight:2,opacity:1,fillOpacity:.5,color:"rgba(0,200,200,0.8)",fill:"rgba(0,200,200,0.8)"}},point:{isable:!0,normal:{r:10,fillColor:"rgba(0,200,200,0.8)",color:"transparent",fillOpacity:.8}}};var h=n.dmap=n.dmap||{};h.Draw=u,h.draw=function(t){return new u(t)},module.exports=u;