"use strict";function t(i){i=this.options=e.deepMerge(t.options,i),this.id=Math.floor(1e7*Math.random())+"_"+(new Date).getTime(),this.initialize(i)}var i=require("./../leaflet"),e=require("./../core/utils"),n=require("./../render/canvas"),s=e.getColorFunc,a=require("./../core/animator");t.options={lengthLimit:15,lifeSpeed:.5,delay:30,isAutoUpdate:!0,lineSegmentLonger:1,spriteW:200,spriteH:20,flying:{isable:!0,type:"line",ptsN:9,weight:function(t){return 5*Math.pow(t,3)},spriteHead:null},bgLine:{isable:!1,opacity:1,color:"rgba(105,105,105,1)",weight:5},color:s("rgba(0,150,150,0.8)","rgba(0,100,255, 1)","rgb","linear.Out.1"),scale:function(){return 1},value:function(t){return Math.min(1,t.length/40)},lng:e.getLng,lat:e.getLat,time:e.getTime},t.options=e.deepMerge(a.options,t.options),t=a.extend(t,{events:{},initialize:function(t){var i=t.flying;i&&(this.spriteFlying=i.sprite||this.initSpriteFlying(),this.ctxFlying=i.ctx,t.flying.isSpriteHead&&(this.spriteFlyingHead=t.flying.spriteHead||this.initSpriteFlyingHead()));var e=t.bgLine;e&&(this.ctxBgLine=e.ctx,this.spriteBgLine=e.sprite||this.initSpriteBgLine()),t.isAutoUpdate&&this.initEventsAnim(),this.isable=!0},addTo:function(t){!this._map&&t&&(this._map=t,this._data&&this.updateZoom())},processing:function(){for(var t,e,n,s,a,o,r,l=this._data,h=this.options,g=h.time,p=h.lat,d=h.lng,f=t=g(l[0],0),u=e=d(l[0],0),c=n=p(l[0],0),y=0;y<l.length;y++)s=l[y],s&&(a=p(s),o=d(s),r=g(s,y),r>t&&(t=r),f>r&&(f=r),a>n&&(n=a),c>a&&(c=a),o>e&&(e=o),u>o&&(u=o));this.lifeMax=h.lifeMax=t,this.lifeMin=h.lifeMin=f;var b=i.latLng(c,u),m=i.latLng(n,e);this.bounds=i.latLngBounds(b,m)},getBBox:function(){return this.bounds},isInView:function(t){t=t||this._map.getBounds();var i=this.bounds,e=i._northEast.lng,n=i._northEast.lat,s=i._southWest.lng,a=i._southWest.lat,o=t._northEast.lng,r=t._northEast.lat,l=t._southWest.lng,h=t._southWest.lat;return!(s>l&&s>o||l>e&&o>e||a>h&&a>r||h>n&&r>n)},data:function(t){return t?(this._data=t,this.processing(),this.resetVariables(),void(this.options.isAutoUpdate&&this._map&&this.startAnim())):this._data},render:function(t){t&&this.data(t),this.startAnim()},updateFlying:function(){var t=this.options,i=t.flying;if(i&&this.isable){for(var e,n,s=this.life,a=this._data,o=t.time,r=this.indexLast||0,l=r;l<a.length;l++)if(n=a[l]){if(e=o(n,l),e>s){this.indexLast=l;break}this._addFlyingPt(n)}this._drawFlying()}},updateOptions:function(t){t=this.options=e.deepMerge(this.options,t)},resetVariables:function(){this.indexLast=0,this.flyingPts=[],this.enable("flying"),this.life=this.options.lifeMin||this.lifeMin},enable:function(t){t&&""!==t||(this.enable("flying"),this.enable("bgLine")),"bgLine"===t&&this.options.bgLine&&(this.options.bgLine.isable=!0),"flying"===t&&this.options.flying&&(this.options.flying.isable=!0)},disable:function(t){t&&""!==t||(this.disable("flying"),this.disable("bgLine")),"bgLine"===t&&this.options.bgLine&&(this.options.bgLine.isable=!1),"flying"===t&&this.options.flying&&(this.options.flying.isable=!1)},_addFlyingPt:function(t){var i=this.options,e=i.flying.ptsN,n=i.lat,s=i.lng;this.flyingPts.push({lat:n(t),lng:s(t)}),this.flyingPts.length>e&&this.flyingPts.splice(0,1)},equalTo:function(t){return this.id===t.id?!0:!1},_drawFlying:function(){var t=this.options,e=t.lengthLimit,n=t.lineSegmentLonger,s=t.flying;if(s&&s.isable&&this.isable)for(var a,o,r,l,h,g,p,d,f=this.spriteFlying,u=this.spriteFlyingHead,c=f.width,y=f.height,b=this.flyingPts,m=this._map.latLngToContainerPoint.bind(this._map),L=this.ctxFlying,v=b.length,_=s.weight,w="function"==typeof _?_:function(){return _},M=1/v*c*1,x=v-1;x>=0;x--){a=b[x];var F=m(i.latLng(a.lat,a.lng)),B=F.x,S=F.y;if((r||l)&&(o=(x-1)/v,p=B-r,d=S-l,h=Math.atan2(d,p),g=Math.sqrt(p*p+d*d)+n,e>g)){var E=w(o);L.save(),L.translate(r,l),L.rotate(h);var C=o*c;if(L.drawImage(f,C,0,M,y,0,-E/2,g,E),L.restore(),u&&x>=v-1){{u.width}L.save();var H=L.globalCompositeOperation;L.globalCompositeOperation="destination-over",L.beginPath(),console.log("11"),L.drawImage(u,B-E/2,S-E/2,E,E),L.closePath(),L.globalCompositeOperation=H,L.restore()}}r=B,l=S}},initSpriteFlying:function(){for(var t,i=this.options.color,e=document.createElement("canvas"),n=this.spriteW=e.width=1e3,s=this.spriteH=e.height=20,a=e.getContext("2d"),o=a.createLinearGradient(0,0,n,s),r=300,l=0;r>l;l++)t=l/r,o.addColorStop(t,i(t));return a.fillStyle=o,a.fillRect(0,0,n,s),this.spriteFlying=e,e},initSpriteFlyingHead:function(){var t=this.options.color,i=document.createElement("canvas"),e=i.width=i.height=50,n=i.getContext("2d");return n.fillStyle=t(1),n.arc(e/2,e/2,e,0,2*Math.PI),n.fill(),this.spriteFlyingHead=i,i},initSpriteBgLine:function(){var t=document.createElement("canvas"),i=this.spriteW=t.width=1e3,e=this.spriteH=t.height=20,n=t.getContext("2d");return n.fillStyle=this.options.bgLine.color,n.fillRect(0,0,i,e),this.spriteBgLine=t,t},updateBgLine:function(){this._drawBgLine()},_drawBgLine:function(){var t=this.options,e=t.bgLine;if(e&&this.isable&&e.isable)for(var n,s,a,o,r,l,h,g,p=t.lengthLimit,d=t.lineSegmentLonger,f=this.ctxBgLine,u=t.spriteW,c=t.spriteH,y=this.spriteBgLine,b=this._map.latLngToContainerPoint.bind(this._map),m=this._data,L=m.length,v=e.weight,_=1/L*u*1,w=0;L>w;w++){n=m[w];var M=b(i.latLng(n.lat,n.lng)),x=M.x,F=M.y;if(s=(w-1)/L,(a||o)&&(h=x-a,g=F-o,r=Math.atan2(g,h),l=Math.sqrt(h*h+g*g)+d,p>l)){f.save(),f.translate(a,o),f.rotate(r);var B=s*u;f.drawImage(y,B,0,_,c,0,-v/2,l,v),f.restore()}a=x,o=F}},updateAnim:function(t){return this.isInView()?(this.life=t=t||this.life||0,this.isEnd()?this.emit("lifeEnd"):void this.updateFlying()):void 0},isEnd:function(){return this.life>=this.lifeMax+(this.options.delay||0)},updateMap:function(t){this.isInView(t)&&this._drawBgLine()},initEventsAnim:function(){this.off("lifeEnd").on("lifeEnd",function(){this.pause()}).off("update").on("update",this.updateAnim.bind(this))},genOptions:function(){return t.prototype.options=e.deepMerge(a.prototype.genOptions(),t.prototype.options)}}),t.prototype.genOptions();var o=i.dmap=i.dmap||{};o.TrailCanvas=t,o.trailCanvas=function(i){return new t(i)},module.exports=t;