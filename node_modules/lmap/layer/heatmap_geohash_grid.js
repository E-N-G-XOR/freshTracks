"use strict";function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}var a=function(){function e(e,t){for(var n=0;n<t.length;n++){var a=t[n];a.enumerable=a.enumerable||!1,a.configurable=!0,"value"in a&&(a.writable=!0),Object.defineProperty(e,a.key,a)}}return function(t,n,a){return n&&e(t.prototype,n),a&&e(t,a),t}}(),i=require("konva"),o=require("lodash"),r=require("./../leaflet"),s=require("bcore/event"),u=require("./../core/utils"),h=require("./../render/leaflet_layer_konva"),c=require("ngeohash"),l=function(s){function l(n){e(this,l);var a=t(this,(l.__proto__||Object.getPrototypeOf(l)).call(this));return a.draw=o.debounce(a._draw.bind(a),1),a.options=u.deepMerge(l.options,n),a.isable=n.isable!==!1,a}return n(l,s),a(l,[{key:"enable",value:function(){this.isable=!0,this.kLeafLayer&&this.kLeafLayer.enable()}},{key:"disable",value:function(){this.isable=!1,this.kLeafLayer&&this.kLeafLayer.disable()}},{key:"addTo",value:function(e){this._map=e,this.initKonva(),this.initEventsMap()}},{key:"render",value:function(e){e&&(this.data(e),this.clean()),this.draw()}},{key:"initKonva",value:function(){var e=this._map;if(e){var t=this.options,n=e.getSize(),a=this.konvaContainer=u.createContainer(t.container),o=new i.Stage({container:a,width:n.x,height:n.y}),r=this.kLeafLayer=new h(o,{transition:t.lazyFresh.transition,shapeNPerLayer:t.shapeNPerLayer});r.addTo(e),this.initEventsShapes()}}},{key:"_draw",value:function(){var e=this,t=this._data;if(t&&this.isable){var n=this.kLeafLayer,a=void 0;o.forEach(t,function(t,i){a=e.createShapeAttr(t,i),n.addOrSetShape(a)}),n.stopLazyFresh(),n.lazyFresh()}}},{key:"createShapeAttr",value:function(e,t){var n=this;if(this.isable){var a=this.options,o=[];return e.__latlngs.forEach(function(e){var t=n._map.latLngToContainerPoint(r.latLng(e[1],e[0]));o.push(t.x,t.y)}),{data:e,Constructor:i.Line,index:t,id:u.switchValue(a.id,e),attrs:{points:o,fill:u.switchValue(a.fill,e),stroke:u.switchValue(a.stroke,e),strokeWidth:u.switchValue(a.weight,e),closed:!0}}}}},{key:"initEventsMap",value:function(){this._map.on("moveend",o.debounce(this.draw.bind(this),120)).on("zoomend",o.debounce(this.draw.bind(this),120))}},{key:"initEventsShapes",value:function(){var e=this,t=this.options,n=void 0,a=this.kLeafLayer.onKonva("dragstart",function(){}).onKonva("mouseover touchstart",function(e){n=e.target,n.setAttrs({fill:u.switchValue(t.hoverColor||"transparent","")}),n.parent.draw()}).onKonva("mouseout",function(e){n=e.target,n.setAttrs(n.__attr),n.parent.draw()}).onKonva("mouseout mouseup touchend",function(){return setTimeout(function(){return a.enableMapEvents()})}).onKonva("mousedown touchstart",this.onMouseDown.bind(this));u.EVENTS.forEach(function(t){a.onKonva(t,function(n){var a=n.target.__id,i=n.target.__data;e.emit("child-"+t,{id:a,data:i}),r.DomEvent.stopPropagation(n)})})}},{key:"onMouseDown",value:function(e){var t=this.options,n=this._map,a=t.popup,i=e.target;if(a&&(a=a.bind(t)),!a){if(!t.child)return;a=t.child.popup,a&&(a=a.bind(t.child))}if(a){var o=a(i.__data);setTimeout(function(){if(i){var e=i.getClientRect(),t=n.containerPointToLatLng(r.point(e.x+e.width/2,e.y));n.openPopup(o,r.latLng(t.lat,t.lng))}},100),this.kLeafLayer.disableMapEvents()}}},{key:"data",value:function(e){this._data=e,this.processing()}},{key:"updateOptions",value:function(e){this.options=u.deepMerge(this.options,e),this.draw()}},{key:"processing",value:function(){var e=this.options,t=e.geohash,n=void 0,a=void 0,i=void 0,r=void 0,s=void 0,u=void 0,h=void 0,l=void 0,f=void 0,d=void 0,p=void 0;o.forEach(this._data,function(e,o){n=t(e,o),a=c.decode_bbox(n),r=a[0],s=a[1],u=a[2],h=a[3],l=[s,r],f=[s,u],d=[h,u],p=[h,r],i=[l,f,d,p,l],e.__latlngs=i}),this.updateRange()}},{key:"updateRange",value:function(){this.range=u.getRangePercentTile(this._data,this.options.value)}},{key:"clean",value:function(){this.kLeafLayer.clean()}},{key:"destroy",value:function(){this.kLeafLayer.destroy(),this.konvaContainer.remove()}}]),l}(s);l.options={container:".leaflet-overlay-pane",fill:"#099",weight:1,value:function(e){return e.count},stroke:"rgba(255,255,255,0.2)",hoverColor:"#0ff",geohash:function(e){return e.geohash},id:function(e){return e.geohash},isable:!0,shapeNPerLayer:1e3,popup:function(e){return e.geohash},lazyFresh:{transition:"opacity 0.4s"}};var f=r.dmap=r.dmap||{};f.HeatmapGeohashGrid=l,f.heatmapGeohashGrid=function(e){return l(e)},module.exports=l;