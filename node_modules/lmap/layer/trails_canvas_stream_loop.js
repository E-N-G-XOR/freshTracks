"use strict";function i(t){t=this.options=n.deepMerge(i.options,t),this.initialize(t)}var t=require("./../leaflet"),n=require("./../core/utils"),e=require("./../render/canvas"),a=n.getColorFunc,s=require("./../core/animator"),r=require("./trail_canvas");i.options={lineN:1e3,lifeSpeed:1,isAutoUpdate:!0,trail:{delay:2,lifeSpeed:1.5,lengthLimit:60,lineSegmentLonger:0,isAutoUpdate:!1,spriteW:200,spriteH:20,flying:{container:"#canvas",isable:!0,blending:"lighter",type:"line",ptsN:25,weight:function(i){return 5*Math.pow(i,3)},isSpriteHead:!0},color:a("rgba(150,0,0,0.3)","rgba(250,150,0, 1)","rgb","linear.Out.2"),value:function(i){return Math.min(1,i.length/40)},lng:n.getLng,lat:n.getLat,time:n.getTime},pts:function(i){return i.p},id:n.getID,lifeMin:0,lifeMax:1e11};var i=s.extend(i,{events:{},initialize:function(i){this.isable=!0;var t=i.trail;this.lifeMax=i.lifeMax,this.lifeMin=i.lifeMin,this.life=this.lifeMin,this.initSpriteFlying(),t.flying&&this.initSpriteFlyingHead(),i.isAutoUpdate&&this.initEventsAnim()},initCanvas:function(){var i=this.options,t=i.trail,n=t.bgLine;if(n){var a=n.opacity,s=n.blending;this.lcanvasBg=new e(this._map,n.container,{clearAlpha:.9});var r=this.ctxBg=this.lcanvasBg.ctx;r.globalAlpha=a,r.globalCompositeOperation=s,n.ctx=r}var l=t.flying;if(l){var o=l.blending;this.lcanvas=new e(this._map,l.container,{clearAlpha:1});var h=this.ctxFlying=this.lcanvas.ctx;h.globalCompositeOperation=o,l.ctx=h}},addTo:function(i){!this._map&&i&&(this._map=i,this.initCanvas(),this.initTrails(),this.initEventsMap(),this._data&&this.updateZoom())},clear:function(){var i,t=this.using,n=this.unusing;for(var e in t)i=t[e],i.reset();this.using=[],n=[];var a=this.trails;for(var s in a)n[s]=a[s];this.unusing=n},reset:function(){var i=this.unusing=[];this.using=[];for(var t=this.trails,n=0;n<t.length;n++){var e=t[n];e.stop&&e.stop(),e.pause&&e.pause(),e.resetVariables()}this.life=this.options.lifeMin,this.using=[];for(var t=this.trails,a=0;a<t.length;a++)i.push(t[a]);this.resume()},initCacheColor:function(){},data:function(i){if(!i)return this._data;var t=this.unusing,n=this.using;if(t&&t.length){var e=t.pop(),a=this.options,s=a.pts,r=s(i);e.updateOptions({lifeMin:0,lifeMax:r.length}),e.data(r),n.push(e),this.options.isAutoUpdate&&this._map&&!this.loopid&&this.startAnim()}},datas:function(i){if(!i)return this._data;for(var t in i)this.data(i[t])},initTrails:function(){for(var i,t=this.options,n=t.trail,e=(this.using=[],this.unusing=[]),a=this._map,s=this.trails=[],l=t.lineN,o=0;l>o;o++)i=new r(n),i.addTo(a),this.initEventsTrail(i),s.push(i),e.push(i)},checkTrail:function(i){if(i.isEnd()){var t=this.using,n=!1;for(var e in t)if(t[e].equalTo(i)){n=!0,t.splice(e,1);break}n&&this.unusing.push(i)}},initEventsTrail:function(i){var t=this;i.on("lifeEnd",function(){t.emit("flying-end",i._data)})},updateOptions:function(){var i,t=this.options,n=this.trails;for(var e in n)i=n[e],i.updateOptions(t)},render:function(){},updateAnim:function(i){if(this.isable){this.iii=this.iii||0;{this.ctxFlying}this.lcanvas.clear(),i=i||this.life;for(var t=this.using,n=this.options.trail,e=t.length-1;e>=0;e--){var a=t[e];i=a.life+n.lifeSpeed,a.updateAnim(i),this.checkTrail(a)}}},updateMap:function(){if(this.isable){var i=this.ctxBg;i&&i.clearRect(0,0,i.canvas.width,i.canvas.height);var t=this.ctxFlying;t&&t.clearRect(0,0,t.canvas.width,t.canvas.height);for(var n=this._map.getBounds(),e=this.using,a=0;a<e.length;a++){var s=e[a];s&&s.updateMap(n)}}},clean:function(){var i=this.ctxBg;i&&i.clearRect(0,0,i.canvas.width,i.canvas.height);var t=this.ctxFlying;t&&t.clearRect(0,0,t.canvas.width,t.canvas.height)},enable:function(){this.isable=!0,this.resume(),this.updateMap()},disable:function(){this.clean(),this.pause(),this.isable=!1},initEventsMap:function(){var i=this;this._map.on("movestart",function(){i.clean()}).on("moveend",function(){i.updateMap()}.bind(this))},initSpriteFlying:function(){for(var i,t=this.options.trail,n=t.color,e=document.createElement("canvas"),a=this.spriteW=e.width=t.spriteW,s=this.spriteH=e.height=t.spriteH,r=e.getContext("2d"),l=r.createLinearGradient(0,0,a,s),o=100,h=0;o>h;h++)i=h/o,l.addColorStop(i,n(i));r.fillStyle=l,r.fillRect(0,0,a,s),this.spriteFlying=e,t.flying.sprite=e},initSpriteFlyingHead:function(){var i=this.options.trail,t=i.color,n=document.createElement("canvas"),e=n.width=n.height=50,a=e/2,s=n.getContext("2d");return s.fillStyle=t(1),s.arc(a,a,a,0,2*Math.PI),s.fill(),this.spriteFlyingHead=n,i.flying.spriteHead=n,n},select:function(i){var t,n,e=this.trails;this.clean();for(var a=0;a<e.length;a++)t=e[a],n=t.id,i&&n in i?(t.enable(),t.updateBgLine()):t.disable()},unselect:function(){var i,t=this.trails;this.clean();for(var n=0;n<t.length;n++)i=t[n],i&&i.enable("flying"),i&&i.disable("bgLine")},initEventsAnim:function(){this.on("update",function(i){this.updateAnim(i)})},genOptions:function(){return i.prototype.options=n.deepMerge(s.prototype.genOptions(),i.prototype.options)}}),l=t.dmap=t.dmap||{};l.TrailsCanvas=i,l.trailsCanvas=function(t){return new i(t)},i.prototype.genOptions(),module.exports=i;