"use strict";var t=require("./../map/map"),i=require("./../leaflet");require("./edit_circle.css");var n=require("bcore/utils"),e=i.Circle.extend({options:{infoNode:{className:"leaflet-edit-node no-events"}},initialize:function(t,n,e){i.Circle.prototype.initialize.call(this,t,n,e),opt=i.setOptions(e),this.id=this.options.id},addTo:function(t){return i.Circle.prototype.addTo.call(this,t),this._initEditDot(),this.addEvents(),this.addEventsEditDot(),this._onMovingEnd(),this._initInfoMarker(),this._updateCommon(),this},addEvents:function(){var t=this,i=this._container;i.addEventListener("mousedown",function(){t._disableMarker(),t.isDown=!0}),i.addEventListener("mousemove",t._onMoving.bind(t)),i.addEventListener("mouseover",t._onHover.bind(t)),i.addEventListener("mouseout",t._onMovingEnd.bind(t)),i.addEventListener("mouseup",function(){t.isDown=!1,t.infoMarker&&(t.infoMarker._icon.innerHTML="")})},addInfo:function(t){t&&(this.info=t)},addEventsEditDot:function(){{var t=this,n=this.editRadiusDot,e=n._container;this._map}e.addEventListener("mouseover",function(t){n.setStyle({fillOpacity:.9}),t.stopPropagation(),i.DomEvent.stopPropagation(t)}),e.addEventListener("mousedown",function(n){t._initInfoMarker(),t._disableMarker(),t.isDotDown=!0,n.stopPropagation(),i.DomEvent.stopPropagation(n)}),e.addEventListener("mousemove",t._onScaling.bind(t)),e.addEventListener("mouseup",function(){t.isDotDown=!1}),e.addEventListener("mouseout",function(){t._onScalingEnd()})},_initEditDot:function(){this.editRadiusDot=i.circleMarker(this._latlng,{radius:15,weight:0,fillColor:"#0ff",fillOpacity:0}).addTo(this._map);this._updateEditDotPos()},_initInfoMarker:function(){if(!this.infoMarker){var t;if(t=this.options.infoNode){var n=this.icon=i.divIcon({className:t.className,html:"",iconSize:null});this.infoMarker=i.marker(this._latlng,{icon:n}).addTo(this._map)}}},_onHover:function(t){if(!this.isEdit){var i=this.infoMarker._icon;i.setAttribute("class","leaflet-edit-node leaflet-edit-node-submit"),i.innerHTML="删除",this.editRadiusDot.setStyle({fillOpacity:.8}),this.setStyle({dashArray:"12, 6",weight:"2",color:"#0ff"}),t.stopPropagation()}},_onMoving:function(t){t.stopPropagation(),i.DomEvent.stopPropagation(t),this.isDown&&(this.isEdit=!0,this._updateCenterPos(t),this._updateInfoMoving(),this.updateEditing())},_disableMarker:function(){var t=this.infoMarker._icon;t.setAttribute("class","leaflet-edit-node no-events")},_updateMarkerPos:function(t){this.infoMarker.setLatLng(t)},_updateCenterPos:function(t){var i=this._map,n=i.mouseEventToContainerPoint(t),e=i.containerPointToLayerPoint(n),o=i.layerPointToLatLng(e);this.setLatLng(o),this._updateMarkerPos(o),t.stopPropagation(),this._updateEditDotPos()},_updateEditDotPos:function(){var t=this._getLngRadius(),n=this._latlng,e=i.latLng(n.lat,n.lng+t);this.editRadiusDot.setLatLng(e)},_onMovingEnd:function(t){return this.isDown=!1,this.isEdit?this.updateEdited():(this.editRadiusDot.setStyle({fillOpacity:0}),this.setStyle({weight:2,dashArray:"",color:"#0ff"}),t&&i.DomEvent.stopPropagation(t),void(t&&t.stopPropagation()))},_onScaling:function(t){if(this.isDotDown){this.isEdit=!0;var n=this.editRadiusDot,e=this._map,o=e.mouseEventToContainerPoint(t),s=e.containerPointToLayerPoint(o),a=e.layerPointToLatLng(s);n.setLatLng(a);var r=this._latlng,d=r.distanceTo(i.latLng(r.lat,a.lng));this.setRadius(d),this._updateInfoScaling(),t.stopPropagation(),this.updateEditing()}},_onScalingEnd:function(){return this.isDotDown=!1,this.isEdit?this.updateEdited():void this._updateCommon()},_updateInfoMoving:function(){var t="经度"+this._latlng.lat.toFixed(5)+" | 纬度"+this._latlng.lng.toFixed(5);this.infoMarker._icon.innerHTML=t},_updateInfoScaling:function(){var t="半径 "+parseInt(this.getRadius())+"米";this.infoMarker._icon.innerHTML=t},_updateCommon:function(){this.editRadiusDot.setStyle({fillColor:"#0ff"}),this.setStyle({color:"#0ff",dashArray:""});var t=this.infoMarker._icon;t.setAttribute("class","leaflet-edit-node no-events"),t.innerHTML="",this._addButtonDeleteEvent()},updateEditing:function(){this.editRadiusDot.setStyle({fillColor:"#930"}),this.setStyle({color:"#930",dashArray:"12, 6"})},updateEdited:function(){if(this.editRadiusDot.setStyle({fillColor:"#930"}),this.setStyle({color:"#930",dashArray:"12, 6"}),this.infoMarker){var t=this.infoMarker._icon;t.setAttribute("class","leaflet-edit-node leaflet-edit-node-submit"),t.innerHTML=this.isUploading?"上传中..":"提交",this._addButtonSubmitEvent()}},_onOperationEnd:function(){return this.isEdit?this.updateEdited():void this._updateCommon()},_addButtonSubmitEvent:function(){this.infoMarker._icon.removeEventListener("click"),this.infoMarker._icon.addEventListener("click",this._onSubmit.bind(this))},_addButtonDeleteEvent:function(){this.infoMarker._icon.removeEventListener("click"),this.infoMarker._icon.addEventListener("click",this._onDelete.bind(this))},_onDelete:function(){this.isUploading=!0,this.infoMarker._icon.innerHTML="删除中..",this.fire("delete")},_onSubmit:function(){this.isUploading=!0,console.log(this.infoMarker,this),this.infoMarker._icon.innerHTML="上传中..",this.fire("upload")},onCreateCallback:function(t){this.id=t,this.isUploading=!1,this.isEdit=!1,this.infoMarker._icon.removeEventListener("click"),this._updateCommon()},onModifyCallback:function(){this.isUploading=!1,this.isEdit=!1,this.infoMarker._icon.removeEventListener("click"),this._updateCommon()},_onDeleteCallback:function(){this.destory()},destory:function(){var t=this._map;this.editRadiusDot&&t.removeLayer(this.editRadiusDot),this.infoMarker&&t.removeLayer(this.infoMarker),t.removeLayer(this)}});module.exports=e;