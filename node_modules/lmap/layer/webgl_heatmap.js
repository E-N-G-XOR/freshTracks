"use strict";function e(t){var t=this.options=f.deepMerge(e.options,t)}var t,n,r,i,a,l,o,s,u,h=require("./gl/texture");__indexOf=[].indexOf||function(e){for(var t=0,n=this.length;n>t;t++)if(t in this&&this[t]===e)return t;return-1};var f=require("./../core/utils"),_=require("bcore/event"),g=require("./../leaflet"),c=require("./../render/canvas"),n=require("./gl/heights"),i=require("./gl/shader");u=require("./gl/vertexShaderBlit"),l=require("./gl/fragmentShaderBlit"),o=function(){var e,t,n,r;return null!=window.WebGLRenderingContext?(r=["WEBKIT","MOZ","MS","O"],n=/^WEBKIT_(.*)|MOZ_(.*)|MS_(.*)|O_(.*)/,e=WebGLRenderingContext.prototype.getExtension,WebGLRenderingContext.prototype.getExtension=function(t){var i,a,l,o,s;if(a=t.match(n),null!==a&&(t=a[1]),i=e.call(this,t),null===i){for(o=0,s=r.length;s>o;o++)if(l=r[o],i=e.call(this,l+"_"+t),null!==i)return i;return null}return i},t=WebGLRenderingContext.prototype.getSupportedExtensions,WebGLRenderingContext.prototype.getSupportedExtensions=function(){var e,r,i,a,l,o;for(a=t.call(this),i=[],l=0,o=a.length;o>l;l++)e=a[l],r=e.match(n),null!==r&&(e=r[1]),__indexOf.call(i,e)<0&&i.push(e);return i}):void 0},s=function(){var e,t,n,r,i,a,l,o,s,u,h,f,_,g;if(i=function(){var e,t,n;return e=document.createElement("canvas"),e.width=2,e.height=2,t=e.getContext("2d"),n=t.getImageData(0,0,2,2),n.data.set(new Uint8ClampedArray([0,0,0,0,255,255,255,255,0,0,0,0,255,255,255,255])),t.putImageData(n,0,0),e},i(),t=function(e,t){var n,r,a,l,o,s,u,h,f,_,g,c,E,d;if(s=e.createProgram(),E=e.createShader(e.VERTEX_SHADER),e.attachShader(s,E),e.shaderSource(E,"attribute vec2 position;\nvoid main(){\n    gl_Position = vec4(position, 0.0, 1.0);\n}"),e.compileShader(E),!e.getShaderParameter(E,e.COMPILE_STATUS))throw e.getShaderInfoLog(E);if(a=e.createShader(e.FRAGMENT_SHADER),e.attachShader(s,a),e.shaderSource(a,"uniform sampler2D source;\nvoid main(){\n    gl_FragColor = texture2D(source, vec2(1.0, 1.0));\n}"),e.compileShader(a),!e.getShaderParameter(a,e.COMPILE_STATUS))throw e.getShaderInfoLog(a);if(e.linkProgram(s),!e.getProgramParameter(s,e.LINK_STATUS))throw e.getProgramInfoLog(s);return e.useProgram(s),r=function(){return e.deleteShader(a),e.deleteShader(E),e.deleteProgram(s),e.deleteBuffer(n),e.deleteTexture(f),e.deleteTexture(c),e.deleteFramebuffer(l),e.bindBuffer(e.ARRAY_BUFFER,null),e.useProgram(null),e.bindTexture(e.TEXTURE_2D,null),e.bindFramebuffer(e.FRAMEBUFFER,null)},c=e.createTexture(),e.bindTexture(e.TEXTURE_2D,c),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,2,2,0,e.RGBA,e.UNSIGNED_BYTE,null),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),l=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,l),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,c,0),_=i(),f=e.createTexture(),e.bindTexture(e.TEXTURE_2D,f),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,t,_),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),d=new Float32Array([1,1,-1,1,-1,-1,1,1,-1,-1,1,-1]),n=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,d,e.STATIC_DRAW),o=e.getAttribLocation(s,"position"),g=e.getUniformLocation(s,"source"),e.enableVertexAttribArray(o),e.vertexAttribPointer(o,2,e.FLOAT,!1,0,0),e.uniform1i(g,0),e.drawArrays(e.TRIANGLES,0,6),u=new Uint8Array(16),e.readPixels(0,0,2,2,e.RGBA,e.UNSIGNED_BYTE,u),h=Math.abs(u[0]-127)<10,r(),h},r=function(e,t){var n;return n=e.createTexture(),e.bindTexture(e.TEXTURE_2D,n),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,2,2,0,e.RGBA,t,null),0===e.getError()?(e.deleteTexture(n),!0):(e.deleteTexture(n),!1)},e=function(e,t){var n,r,i;return i=e.createTexture(),e.bindTexture(e.TEXTURE_2D,i),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,2,2,0,e.RGBA,t,null),r=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,r),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,i,0),n=e.checkFramebufferStatus(e.FRAMEBUFFER),e.deleteTexture(i),e.deleteFramebuffer(r),e.bindTexture(e.TEXTURE_2D,null),e.bindFramebuffer(e.FRAMEBUFFER,null),n===e.FRAMEBUFFER_COMPLETE?!0:!1},s=[],u={},h=[],n=function(){var n,i,a,l,o,f,_;n=document.createElement("canvas"),a=null;try{a=n.getContext("experimental-webgl"),null===a&&(a=n.getContext("webgl"))}catch(g){}return null!=a&&(f=a.getExtension("OES_texture_float"),null===f?r(a,a.FLOAT)?(_=!0,s.push("OES_texture_float"),u.OES_texture_float={shim:!0}):(_=!1,h.push("OES_texture_float")):r(a,a.FLOAT)?(_=!0,s.push("OES_texture_float")):(_=!1,h.push("OES_texture_float")),_&&(i=a.getExtension("WEBGL_color_buffer_float"),null===i?e(a,a.FLOAT)?(s.push("WEBGL_color_buffer_float"),u.WEBGL_color_buffer_float={shim:!0,RGBA32F_EXT:34836,RGB32F_EXT:34837,FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT:33297,UNSIGNED_NORMALIZED_EXT:35863}):h.push("WEBGL_color_buffer_float"):e(a,a.FLOAT)?s.push("WEBGL_color_buffer_float"):h.push("WEBGL_color_buffer_float"),i=a.getExtension("OES_texture_float_linear"),null===i?t(a,a.FLOAT)?(s.push("OES_texture_float_linear"),u.OES_texture_float_linear={shim:!0}):h.push("OES_texture_float_linear"):t(a,a.FLOAT)?s.push("OES_texture_float_linear"):h.push("OES_texture_float_linear")),l=a.getExtension("OES_texture_half_float"),null===l?r(a,36193)?(o=!0,s.push("OES_texture_half_float"),l=u.OES_texture_half_float={HALF_FLOAT_OES:36193,shim:!0}):(o=!1,h.push("OES_texture_half_float")):r(a,l.HALF_FLOAT_OES)?(o=!0,s.push("OES_texture_half_float")):(o=!1,h.push("OES_texture_half_float")),o)?(i=a.getExtension("EXT_color_buffer_half_float"),null===i?e(a,l.HALF_FLOAT_OES)?(s.push("EXT_color_buffer_half_float"),u.EXT_color_buffer_half_float={shim:!0,RGBA16F_EXT:34842,RGB16F_EXT:34843,FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT:33297,UNSIGNED_NORMALIZED_EXT:35863}):h.push("EXT_color_buffer_half_float"):e(a,l.HALF_FLOAT_OES)?s.push("EXT_color_buffer_half_float"):h.push("EXT_color_buffer_half_float"),i=a.getExtension("OES_texture_half_float_linear"),null===i?t(a,l.HALF_FLOAT_OES)?(s.push("OES_texture_half_float_linear"),u.OES_texture_half_float_linear={shim:!0}):h.push("OES_texture_half_float_linear"):t(a,l.HALF_FLOAT_OES)?s.push("OES_texture_half_float_linear"):h.push("OES_texture_half_float_linear")):void 0},null!=window.WebGLRenderingContext){for(n(),f={},_=0,g=h.length;g>_;_++)o=h[_],f[o]=!0;return a=WebGLRenderingContext.prototype.getExtension,WebGLRenderingContext.prototype.getExtension=function(e){var t;return t=u[e],void 0===t?f[e]?null:a.call(this,e):t},l=WebGLRenderingContext.prototype.getSupportedExtensions,WebGLRenderingContext.prototype.getSupportedExtensions=function(){var e,t,n,r,i,a,o;for(n=l.call(this),t=[],r=0,a=n.length;a>r;r++)e=n[r],void 0===f[e]&&t.push(e);for(i=0,o=s.length;o>i;i++)e=s[i],__indexOf.call(t,e)<0&&t.push(e);return t},WebGLRenderingContext.prototype.getFloatExtension=function(e){var t,n,r,i,a,l,s,u,h,f,_,g,c,E,d,p,T,x,R,m,b,v,A,F,S,y;for(null==e.prefer&&(e.prefer=["half"]),null==e.require&&(e.require=[]),null==e["throws"]&&(e["throws"]=!0),E=this.getExtension("OES_texture_float"),l=this.getExtension("OES_texture_half_float"),g=this.getExtension("WEBGL_color_buffer_float"),i=this.getExtension("EXT_color_buffer_half_float"),c=this.getExtension("OES_texture_float_linear"),a=this.getExtension("OES_texture_half_float_linear"),_={texture:null!==E,filterable:null!==c,renderable:null!==g,score:0,precision:"single",half:!1,single:!0,type:this.FLOAT},r={texture:null!==l,filterable:null!==a,renderable:null!==i,score:0,precision:"half",half:!0,single:!1,type:null!=(F=null!=l?l.HALF_FLOAT_OES:void 0)?F:null},n=[],_.texture&&n.push(_),r.texture&&n.push(r),f=[],p=0,R=n.length;R>p;p++){for(t=n[p],d=!0,S=e.require,T=0,m=S.length;m>T;T++)o=S[T],t[o]===!1&&(d=!1);d&&f.push(t)}for(x=0,b=f.length;b>x;x++)for(t=f[x],y=e.prefer,s=A=0,v=y.length;v>A;s=++A)h=y[s],u=Math.pow(2,e.prefer.length-s-1),t[h]&&(t.score+=u);if(f.sort(function(e,t){return e.score===t.score?0:e.score<t.score?1:e.score>t.score?-1:void 0}),0===f.length){if(e["throws"])throw"No floating point texture support that is "+e.require.join(", ");return null}return f=f[0],{filterable:f.filterable,renderable:f.renderable,type:f.type,precision:f.precision}}}},o(),s(),a=function(){function e(e){var t,r,a,o,s,f,_,g,c,E,d,p,T;p=null!=e?e:{},this.canvas=p.canvas,this.width=p.width,this.height=p.height,g=p.intensityToAlpha,f=p.gradientTexture,r=p.alphaRange,this.canvas||(this.canvas=document.createElement("canvas"));try{if(this.gl=this.canvas.getContext("experimental-webgl",{depth:!1,antialias:!1}),null===this.gl&&(this.gl=this.canvas.getContext("webgl",{depth:!1,antialias:!1}),null===this.gl))throw"WebGL not supported"}catch(x){throw o=x,"WebGL not supported"}null!=window.WebGLDebugUtils&&(console.log("debugging mode"),this.gl=WebGLDebugUtils.makeDebugContext(this.gl,function(e,t){throw WebGLDebugUtils.glEnumToString(e)+" was caused by call to: "+t})),this.gl.enableVertexAttribArray(0),this.gl.blendFunc(this.gl.ONE,this.gl.ONE),f?(d=this.gradientTexture=new h(this.gl,{channels:"rgba"}).bind(0).setSize(2,2).nearest().clampToEdge(),"string"==typeof f?(_=new Image,_.onload=function(){return d.bind().upload(_)},_.src=f):f.width>0&&f.height>0?d.upload(f):f.onload=function(){return d.upload(f)},s="uniform sampler2D gradientTexture;\nvec3 getColor(float intensity){\n    return texture2D(gradientTexture, vec2(intensity, 0.0)).rgb;\n}"):(d=null,s="vec3 getColor(float intensity){\n    vec3 blue = vec3(0.0, 0.0, 1.0);\n    vec3 cyan = vec3(0.0, 1.0, 1.0);\n    vec3 green = vec3(0.0, 1.0, 0.0);\n    vec3 yellow = vec3(1.0, 1.0, 0.0);\n    vec3 red = vec3(1.0, 0.0, 0.0);\n\n    vec3 color = (\n        fade(-0.25, 0.25, intensity)*blue +\n        fade(0.0, 0.5, intensity)*cyan +\n        fade(0.25, 0.75, intensity)*green +\n        fade(0.5, 1.0, intensity)*yellow +\n        smoothstep(0.75, 1.0, intensity)*red\n    );\n    return color;\n}"),null==g&&(g=!0),g?(T=null!=r?r:[0,1],a=T[0],t=T[1],c="vec4 alphaFun(vec3 color, float intensity){\n    float alpha = smoothstep("+a.toFixed(8)+", "+t.toFixed(8)+", intensity);\n    return vec4(color*alpha, alpha);\n}"):c="vec4 alphaFun(vec3 color, float intensity){\n    return vec4(color, 1.0);\n}",this.shader=new i(this.gl,{vertex:u,fragment:l+("float linstep(float low, float high, float value){\n    return clamp((value-low)/(high-low), 0.0, 1.0);\n}\n\nfloat fade(float low, float high, float value){\n    float mid = (low+high)*0.5;\n    float range = (high-low)*0.5;\n    float x = 1.0 - clamp(abs(mid-value)/range, 0.0, 1.0);\n    return smoothstep(0.0, 1.0, x);\n}\n\n"+s+"\n"+c+"\n\nvoid main(){\n    float intensity = smoothstep(0.0, 1.0, texture2D(source, texcoord).r);\n    vec3 color = getColor(intensity);\n    gl_FragColor = alphaFun(color, intensity);\n}")}),null==this.width&&(this.width=this.canvas.offsetWidth||2),null==this.height&&(this.height=this.canvas.offsetHeight||2),this.canvas.width=this.width,this.canvas.height=this.height,this.gl.viewport(0,0,this.width,this.height),this.quad=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.quad),E=new Float32Array([-1,-1,0,1,1,-1,0,1,-1,1,0,1,-1,1,0,1,1,-1,0,1,1,1,0,1]),this.gl.bufferData(this.gl.ARRAY_BUFFER,E,this.gl.STATIC_DRAW),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,null),this.heights=new n(this,this.gl,this.width,this.height)}return e.prototype.adjustSize=function(){var e,t;return t=this.canvas.offsetWidth||2,e=this.canvas.offsetHeight||2,this.width!==t||this.height!==e?(this.gl.viewport(0,0,t,e),this.canvas.width=t,this.canvas.height=e,this.width=t,this.height=e,this.heights.resize(this.width,this.height)):void 0},e.prototype.display=function(){return this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.quad),this.gl.vertexAttribPointer(0,4,this.gl.FLOAT,!1,0,0),this.heights.nodeFront.bind(0),this.gradientTexture&&this.gradientTexture.bind(1),this.shader.use()["int"]("source",0)["int"]("gradientTexture",1),this.gl.drawArrays(this.gl.TRIANGLES,0,6)},e.prototype.update=function(){return this.heights.update()},e.prototype.clear=function(){return this.heights.clear()},e.prototype.clamp=function(e,t){return null==e&&(e=0),null==t&&(t=1),this.heights.clamp(e,t)},e.prototype.multiply=function(e){return null==e&&(e=.95),this.heights.multiply(e)},e.prototype.blur=function(){return this.heights.blur()},e.prototype.addPoint=function(e,t,n,r){return this.heights.addPoint(e,t,n,r)},e.prototype.addPoints=function(e){var t,n,r,i;for(i=[],n=0,r=e.length;r>n;n++)t=e[n],i.push(this.addPoint(t.x,t.y,t.size,t.intensity));return i},e}(),e.options={intensity:.2,lat:f.getLat,lng:f.getLng,size:function(){return 3},quality:1,container:"tilePane",clearPhi:0},e=_.extend(e,{addTo:function(e){e&&(this._map=e,this.transfer=e.latLngToContainerPoint.bind(e),this.initialize())},initialize:function(){var e,t=this.options,n=t.container;if("string"==typeof n){var r,i,l=this._map.getPanes();n=l[n]}else n=f.getContainer(n);var o=this._map.getSize(),r=o.x,i=o.y,e=t.quality,s=document.createElement('<canvas width="'+r*e+'" height="'+i*e+'"><canvas>');s.style.position="absolute",s.style.left="0",s.style.top="0",s.style.pointerEvents="none",s.style.width=r+"px",s.style.height=i+"px",n.appendChild(s),this.heatmap=new a({canvas:s}),this.initEvents()},data:function(e){this._data=e},render:function(e){e&&this.data(e);var t=this.options,n=this.transfer,r=this.heatmap;r.multiply(t.clearPhi);var i=t.intensity,a=t.lat,l=t.lng,o=t.size;e=this._data;var s,u,h,f,_,c=this._map.getZoom();for(var E in e)s=e[E],u=a(s),h=l(s),latlng=g.latLng(u,h),f=n(latlng),_=o(s,c),r.addPoint(f.x,f.y,_,i);r.update(),r.display()},resetPos:function(){var e=this.canvas[0],t=g.DomUtil.getPosition(this._map.getPanes().mapPane);t&&g.DomUtil.setPosition(e,{x:-t.x,y:-t.y})},clean:function(){var e=this.heatmap;e.multiply(0),e.update(),e.display()},initEvents:function(){{var e=this;this.heatmap}this._map.on("moveend",function(){e.resetPos(),e.render()}).on("zoomstart",function(){e.clean()})}}),g=g||{},g.dmap=g.dmap||{},g.dmap.webGLHeatmap=function(t){return new e(t)},module.exports=e;