"use strict";function t(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function e(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function i(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}var n=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),a=require("./../leaflet"),r=require("konva"),o=require("lodash"),s=require("bcore/event"),u=require("./../render/leaflet_layer_konva"),h=require("./../core/utils"),l=h.getSprite,d=h.fireEvent,c=h.switchValue,f=function(s){function d(i){t(this,d);var n=e(this,(d.__proto__||Object.getPrototypeOf(d)).call(this));return i=n.options=h.deepMerge(d.options,i),n.resetVariables(),n}return i(d,s),n(d,[{key:"resetVariables",value:function(){this.enable()}},{key:"disable",value:function(){this.isable=!1,this.kLeafLayer&&this.kLeafLayer.disable()}},{key:"enable",value:function(){this.isable=!0,this.kLeafLayer&&this.kLeafLayer.enable()}},{key:"addTo",value:function(t){!this._map&&t&&(this._map=t,this.initKonva(),this.initEventsMap(),this.initEventsShapes())}},{key:"initEventsShapes",value:function(){var t,e=this,i=this.options,n=i.hoverScale||1,a=this.kLeafLayer.onKonva("dragstart",function(){}).onKonva("mouseover touchstart",function(e){t=e.target,t.setAttrs({scale:{x:n,y:n},fill:i.hoverColor||"transparent"}),t.parent.draw()}).onKonva("mouseout",function(e){t=e.target,t.setAttrs({scale:{x:1,y:1},fill:"transparent"}),t.parent.draw()}).onKonva("mouseout mouseup touchend",function(){setTimeout(function(){a.enableMapEvents()})}).onKonva("mousedown touchstart",this.onMouseDown.bind(this)),r=["mouseout","mousedown","mouseover","mouseout","touchstart","touchend","touchup","click"];r.forEach(function(t){a.onKonva(t,function(i){var n=i.target.__id,a=i.target.__data;e.emit("child-"+t,{id:n,data:a})})})}},{key:"onMouseDown",value:function(t){var e=this.options,i=this._map,n=t.target,r=n.__data,o=e.popup;if(o&&(o=o.bind(e)),o||(o=e.child.popup,o&&(o=o.bind(e.child))),o){var s=o(r);setTimeout(function(){if(n){var t=n.getClientRect(),r=t.x+t.width/2,o=t.y+t.height/2/(e.hoverScale||1),u=i.containerPointToLatLng(a.point(r,o));i.openPopup(s,a.latLng(u.lat,u.lng))}}.bind(this),100),this.kLeafLayer.disableMapEvents()}}},{key:"initKonva",value:function(){var t=this._map,e=this.options,i=t.getSize(),n=this.konvaContainer=h.createContainer(e.container),a=new r.Stage({container:n,width:i.x,height:i.y}),o=this.kLeafLayer=new u(a,{transition:e.lazyFresh.transition,blending:e.blending,ptNPerLayer:e.ptNPerLayer});o.addTo(t),this.initEditor()}},{key:"data",value:function(t){this._data=t,this.updateDataZindex()}},{key:"updateDataZindex",value:function(){var t=this.options,e=t.zIndex||t.child.zIndex;e&&(this._data=o.sortBy(this._data,e))}},{key:"updateOptions",value:function(t){var e=this.kLeafLayer;e.resetOffset(),t=this.options=h.deepMerge(this.options,t),e.hideLayers(),e.updateOptions({transition:t.lazyFresh.transition,blending:t.blending,ptNPerLayer:t.ptNPerLayer}),this.draw()}},{key:"updateFilter",value:function(t){t&&"function"==typeof t&&(this.options.filter=t,this.draw())}},{key:"render",value:function(t){this.first=this._data?!1:!0,t&&this.data(t),t=this._data,this.kLeafLayer&&(t&&this.kLeafLayer.beginDraw(),this.draw(),t&&this.kLeafLayer.endDraw())}},{key:"createShapeAttr",value:function(t,e){if(this.isable){var i=this.options,n=i.lat.bind(i),o=i.lng.bind(i),s=c(i.id.bind(i),t,e),u=c(i.size,t)||1,d=n(t),f=o(t);if(!d||!f)return null;var p=this._map.latLngToContainerPoint(a.latLng(d,f));y=i.sprite||i.child.sprite;var y=h.switchValue(y,t);return y=h.getSprite(y),{data:t,Constructor:r.Image,index:e,id:s,attrs:{x:p.x,y:p.y,offset:{x:u/2,y:u/2},image:l(y,t),width:u,height:u,draggable:!1,scaleX:1.2,scaleY:1.2}}}}},{key:"draw",value:function(){var t=this._data;if(t&&this.isable){for(var e,i,n=this.kLeafLayer,a=this.options.filter,r=t.length-1;r>-1;r--)e=t[r],(!a||a(e,r))&&(i=this.createShapeAttr(e,r),i&&n.addOrSetShape(i));n.stopLazyFresh(),n.lazyFresh()}}},{key:"initEventsMap",value:function(){this._map.on("zoomend",this.draw.bind(this)).on("moveend",this.draw.bind(this))}},{key:"destroy",value:function(){this.kLeafLayer.destroy(),this.konvaContainer.remove()}},{key:"clean",value:function(){this.kLeafLayer.clean()}},{key:"initEditor",value:function(){this.eidtList=[],this.kLeafLayer.initEditor(),this.initEventEditor()}},{key:"enableEditor",value:function(){this.kLeafLayer.enableEditor()}},{key:"disableEditor",value:function(){this.kLeafLayer.disableEditor()}},{key:"initEventEditor",value:function(){var t=this;this.kLeafLayer.on("shape-dragged",function(e){t.onShapeDragged(e.shape)})}},{key:"onShapeDragged",value:function(t){var e=t.getClientRect(),i=e.x+e.width/2,n=e.y+e.height/2,r=this._map.containerPointToLatLng(a.point(i,n)),o=this.options,s=o.editor.setLatLng;if(!s)return console.log("请设置options.editor.setLatLng");var u=t.__data;s(r,u),this.kLeafLayer.addOrSetShape(u,null,!0),this.eidtList.push(u),this.fire("data-edited",u)}},{key:"isEdited",value:function(){return this.eidtList.length>0}},{key:"submitEdit",value:function(){this.options,this.eidtList}}]),d}(s);f.options={lng:h.getLng,lat:h.getLat,zIndex:null,refreshInterval:1,ptNPerLayer:1e3,lazyFresh:{transition:"opacity 0.4s"},size:function(){return 40},id:function(t,e){return t.id||e},hoverScale:1.2,blending:"lighter",container:".leaflet-overlay-pane",sprite:{drawN:1.15,color:{from:"rgba(245,230,0,1)",to:"rgba(205,0,0, 0.6)",easing:"Linear.None.1.7",space:"rgb"}},child:{},editor:{setLatLng:function(t,e){e&&(e.lat=t.lat,e.lng=t.lng)}}};var p=a.dmap=a.dmap||{};p.ScatterKonva=f,p.scatterKonva=function(t){return new f(t)},module.exports=f;