"use strict";var t=require("./../leaflet"),i=require("@ali/map-utils"),n=i.Grid,a=i.getColorFunc,r=t.Layer.extend({aggregatedData:{},initialize:function(t){t=this.options=i.deepMerge(r.options,t),this.check(),this.getMax=t.getMax,this.grids=[]},check:function(){var t=this.options;if(!t.appid)throw"必须要设定 appid";if(!t.mapid)throw"必须要设定 mapid";if(!t.data)throw"必须要设定 热力图接口"},addTo:function(i){if(!this._map&&i){this._map=i;var a=this.options.grid;this.gridEncoder=(new n).transform(function(n,a){var r=i.getSize(),o=r.x/2,e=r.y/2,s=o-n,d=e+a,l=o+n,g=e-a,u=i.containerPointToLatLng(t.point(s,d)),c=i.containerPointToLatLng(t.point(l,g));return{dlat:c.lat-u.lat,dlng:c.lng-u.lng}}).shape("rect").rx(a.rx).ry(a.ry).update(),this.initEventsMap(),this.refresh()}},data:function(t){if(!t)return this._data;this._data=t;var i=this.options;i.isAutoUpdate&&this._map&&this.draw(),this.updateColor()},initEventsMap:function(){this._map.on("moveend",this.refresh.bind(this))},refresh:function(){var t=this,i=this.options,n=i.data,a={appid:i.appid,bbox:this.getBounds(),indicator:i.indicator,zoom:this._map.getZoom()};n(a,t.render.bind(this))},getBounds:function(){var t=this._map.getBounds(),i=t._southWest,n=t._northEast,a=.5*(n.lat-i.lat),r=.5*(n.lng-i.lng);return[[i.lat-a,n.lat+a],[i.lng-r,n.lng+r]]},updateColor:function(t,n,a,r){if(t){var o,e,s=this.getColor=i.getColorFunc(t,n,a,r),d=this.gridMap;for(var l in d)o=d[l],e=o._value,o.setStyle({fillColor:s(e)})}},_updateTranformOriginGird:function(t){if(t){var i=t.getBBox(),n=i.width/2+i.x+"px "+(i.height/2+i.y)+"px 0px";t.style["transform-origin"]=n,t.style["-webkit-transform-origin"]=n}},_updateTransformOrigin:function(){if(this.scaleGridFunc){var t=this.gridMap,i=this;setTimeout(function(){for(var n in t)i._updateTranformOriginGird(t[n]._container)})}},render:function(t){t&&this.data(t),this.draw()},clean:function(){var t=this.grids,i=this._map;for(var n in t)i.removeLayer(t[n]);this.grids=[]},draw:function(){this.clean();var i,n,r,o,e,s=this.grids,d=this.options,l=(this.gridEncoder,d.grid.normal),g=a(d.color),u=d.value,c=this._data,h=(this.gridMap,this._map);for(var p in c){var f=c[p];o=f[0],n=f[1],e=f[2],r=f[3];var m=[t.latLng(n,o),t.latLng(r,o),t.latLng(r,e),t.latLng(n,e)],v=u(f);i=t.polygon(m,l).addTo(h),i.setStyle({fillColor:g(v)}),i._value=v,i._heatdata=f,s.push(i),this.initEventsGrid(i),this.scaleGridFunc&&this.scaleGridFunc(i,v)}},initEventsGrid:function(t){var i=this,n=(this.aggregatedData,this.options.grid),a=n.click||{},r=n.mouseover||{},o=n.normal||{},e=t._gridid,s=t._heatdata,d={gridid:e,data:s};t.on("mouseover",function(){r&&t.setStyle(r),i.fire("grid-mouseover",d),t.bringToFront()}).on("mouseout",function(){o&&t.setStyle(o),i.fire("grid-mouseout",d)}).on("mousedown",function(){a&&t.setStyle(a),i.fire("grid-click",d)}).on("dblclick",function(){i.fire("grid-dblclick",d)})}});r.options={appid:null,mapid:null,clusterStepByZoom:1,isAutoUpdate:!0,isNeedAggregate:!0,grid:{mouseover:{opacity:1,color:"#fff",fillOpacity:1},normal:{opacity:0,weight:1,fillOpacity:1},click:{},rx:30,ry:25},color:a("rgba(62,18,0,0.8)","rgba(255,208,122,0.8)","hsl","linear.Out.1.4"),lng:i.getLng,lat:i.getLat,scale:function(){return 1},value:function(t){return t[4]}};var o=t.dmap=t.dmap||{};o.HeatmapGrid=r,o.heatmapGrid=function(t){return r(t)},r.getSizeList=function(i,n,a){for(var r=(a.getCenter(),a.getSize()),o=r.x/2,e=r.y/2,s=o-i,d=e+n,l=o+i,g=e-n,u=a.containerPointToLatLng(t.point(s,d)),c=a.containerPointToLatLng(t.point(l,g)),h=a.containerPointToLatLng(t.point(l,d)),p=c.lat-u.lat,f=c.lng-u.lng,m=u.distanceTo(h),v=c.distanceTo(h),y=a.getZoom(),_=[],L=1;y>L;L++){var x=Math.pow(2,y-L);_[L]={zoom:L,dx:m*x,dy:v*x,dlat:p*x,dlng:f*x}}for(var L=y;19>L;L++){var x=Math.pow(.5,L-y);_[L]={zoom:L,dx:m*x,dy:v*x,dlat:p*x,dlng:f*x}}return _},module.exports=r;