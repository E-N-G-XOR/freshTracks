"use strict";function t(i){i=this.options=n.deepMerge(t.options,i),this.id=Math.floor(1e7*Math.random())+"_"+(new Date).getTime(),this.initialize(i)}var i=require("./../leaflet"),n=require("./../core/utils"),e=require("./../render/canvas"),s=n.getColorFunc,a=n.switchValue,o=require("./../core/animator"),r=require("./../core/utils").getSprite;t.options={lengthLimit:15,lifeSpeed:.5,delay:30,isAutoUpdate:!0,lineSegmentLonger:1,spriteW:200,spriteH:20,container:null,isable:!0,isableDraw:!0,type:"line",ptsN:9,weight:function(t,i){return 5*Math.pow(i,3)},pts:function(t){return t.pts},spriteHead:!0,color:s("rgba(0,150,150,0.8)","rgba(0,100,255, 1)","rgb","linear.Out.1"),scale:function(){return 1},size:function(){return 15},value:function(t){return Math.min(1,t.length/40)},lng:n.getLng,lat:n.getLat,time:n.getTime},t.options=n.deepMerge(o.options,t.options),t=o.extend(t,{events:{},includes:[i.Mixin.Events],initialize:function(t){this.ctx=t.ctx,t.spriteHead&&(this.spriteHead=t.spriteHead||this.initSpriteFlyingHead()),t.isAutoUpdate&&this.initEventsAnim()},addTo:function(t){!this._map&&t&&(this._map=t,this._data&&this.updateZoom())},processing:function(){for(var t,n,e,s,a,o,r,l=this.pts,h=this.options,p=h.time,u=h.lat,d=h.lng,g=t=p(l[0],0),f=n=d(l[0],0),c=e=u(l[0],0),m=0;m<l.length;m++)s=l[m],s&&(a=u(s),o=d(s),r=p(s,m),r>t&&(t=r),g>r&&(g=r),a>e&&(e=a),c>a&&(c=a),o>n&&(n=o),f>o&&(f=o));this.lifeMax=h.lifeMax=t,this.lifeMin=h.lifeMin=g;var v=i.latLng(c,f),b=i.latLng(e,n);this.bounds=i.latLngBounds(v,b)},getBBox:function(){return this.bounds},isInView:function(t){t=t||this._map.getBounds();var i=this.bounds,n=i._northEast.lng,e=i._northEast.lat,s=i._southWest.lng,a=i._southWest.lat,o=t._northEast.lng,r=t._northEast.lat,l=t._southWest.lng,h=t._southWest.lat;return!(s>l&&s>o||l>n&&o>n||a>h&&a>r||h>e&&r>e)},data:function(t){if(!t)return this._data;var i=this.options,n=i.pts.bind(i);this._data=t,this.pts=n(t),this.processing(),this.resetVariables(),this.options.isAutoUpdate&&this._map&&this.startAnim()},append:function(t){return this._data?void this.pts.append(t):console.log("初始数据没有")},render:function(t){t&&this.data(t),this.startAnim()},updateFlying:function(){var t=this.options;if(this.options.isable){for(var i,n,e=this.life,s=this.pts,a=t.time,o=this.indexLast||0,r=o;r<s.length;r++)if(n=s[r]){if(i=a(n,r),i>e){this.indexLast=r;break}this._addFlyingPt(n)}this._drawFlying()}},updateOptions:function(t){t=this.options=n.deepMerge(this.options,t)},resetVariables:function(){this.indexLast=0,this.flyingPts=[],this.enable("flying"),this.life=this.options.lifeMin||this.lifeMin},enable:function(){this.options.isable=!0},disable:function(){this.options.isable=!1},enableDraw:function(){this.options.isableDraw=!0},disableDraw:function(){this.options.isableDraw=!1},_addFlyingPt:function(t){this.curPoint=t;var i=this.options,n=i.ptsN,e=i.lat,s=i.lng;this.flyingPts.push({lat:e(t),lng:s(t)}),this.flyingPts.length>n&&this.flyingPts.splice(0,1)},equalTo:function(t){return this.id===t.id?!0:!1},_drawFlying:function(){var t=this._map,n=t.getZoom(),e=this.options,s=e.lengthLimit,o=e.lineSegmentLonger;if(e.isable&&this.options.isableDraw){for(var l,h,p,u,d,g,f,c,m=e.spriteFlying,v=e.spriteHead,b=r(m),y=r(v),_=b.width,w=b.height,M=this.flyingPts,x=t.latLngToContainerPoint.bind(t),L=this.ctx,E=M.length,P=1/E*_*1,A=E-1;A>=0;A--){l=M[A];var F=x(i.latLng(l.lat,l.lng)),O=F.x,q=F.y;if((p||u)&&(h=(A-1)/E,f=O-p,c=q-u,d=Math.atan2(c,f),g=Math.sqrt(f*f+c*c)+o,s>g)){var C=a(e.weight,l,h);L.save(),L.translate(p,u),L.rotate(d);var D=h*_;L.drawImage(b,D,0,P,w,0,-C/2,g,C),L.restore()}p=O,u=q}if(y&&E){l=M[M.length-1];var F=x(i.latLng(l.lat,l.lng)),O=F.x,q=F.y;L.save();var H=L.globalCompositeOperation;L.globalCompositeOperation="destination-over",L.beginPath();var T=a(e.size,F,n);L.drawImage(y,O-T,q-T,2*T,2*T),L.closePath(),L.globalCompositeOperation=H,L.restore()}}},updateAnim:function(t){return this.isInView()?(this.life=t=t||this.life||0,this.isEnd()?this.emit("lifeEnd"):void this.updateFlying()):void 0},isEnd:function(){return this.life>=this.lifeMax+(this.options.delay||0)},updateMap:function(){},initEventsAnim:function(){this.off("lifeEnd").on("lifeEnd",function(){this.pause()}).off("update").on("update",this.updateAnim.bind(this))},genOptions:function(){return t.prototype.options=n.deepMerge(o.prototype.genOptions(),t.prototype.options)}}),t.prototype.genOptions();var l=i.dmap=i.dmap||{};l.TrailCanvas=t,l.trailCanvas=function(i){return new t(i)},module.exports=t;