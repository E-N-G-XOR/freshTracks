"use strict";function i(t){t=this.options=e.deepMerge(i.options,t),this.initialize(t)}var t=require("./../leaflet"),e=require("./../core/utils"),n=require("./../render/canvas"),a=e.getColorFunc,s=require("./../core/animator"),r=require("./trail_canvas");i.options={lifeSpeed:.1,isAutoUpdate:!0,lifeMin:0,lifeMax:100,trail:{lengthLimit:60,isAutoUpdate:!1,spriteW:200,spriteH:20,flying:{isable:!0,blending:"lighter",type:"line",ptsN:29,weight:function(i){return 8*Math.pow(i,3)},isSpriteHead:!0,container:"#canvas-container"},bgLine:{container:"#canvas-container",isable:!1,blending:"source-over",opacity:1,color:"rgba(250,100,50,0.3)",weight:2},color:{to:"rgba(255,150,0,0.4)",from:"rgba(255,150,0,0.4)",space:"hsl",easing:"linear.Out.1"},value:function(i){return Math.min(1,i.length/40)},lng:e.getLng,lat:e.getLat,time:e.getTime},pts:function(i){return i.p},id:e.getID};var i=s.extend(i,{events:{},initialize:function(i){this.isable=!0;var t=i.trail;this.lifeMax=i.lifeMax,this.lifeMin=i.lifeMin,this.life=this.lifeMin,this.initSpriteFlying(),t.bgLine&&this.initSpriteBgLine(),t.flying&&this.initSpriteFlyingHead(),i.isAutoUpdate&&this.initEventsAnim()},initCanvas:function(){var i=this.options,t=i.trail,e=t.bgLine;if(e){var a=e.opacity,s=e.blending;this.lcanvasBg=new n(this._map,e.container,{});var r=this.ctxBg=this.lcanvasBg.ctx;r.globalAlpha=a,r.globalCompositeOperation=s,e.ctx=r}var l=t.flying;if(l){var o=l.blending;this.lcanvas=new n(this._map,l.container,{});var h=this.ctxFlying=this.lcanvas.ctx;h.globalCompositeOperation=o,l.ctx=h}},addTo:function(i){!this._map&&i&&(this._map=i,this.initCanvas(),this.initEventsMap(),this._data&&this.updateZoom())},initCacheColor:function(){},data:function(i){return i?(this._data=i,this.trailsInView={},this.trailsEnable={},this.initTrails(),void(this.options.isAutoUpdate&&this._map&&this.startAnim())):this._data},initTrails:function(){var i=this.options,t=i.trail,e=i.pts,n=(i.id,this._data),a=this._map,s=this.trails=[];t.flying.ctx=this.ctxFlying;{var l,o,h;this.ctxBg}for(var c in n)l=n[c],o=e(l),h=new r(t),h.addTo(a),h.data(o),s.push({id:c,data:o,trail:h});this.updateMap()},render:function(){},reset:function(){for(var i=this.using,t=0;t<i.length;t++){var e=i[t];e.stop&&e.stop(),e.pause&&e.pause()}this.using=[],this.unsing=this.trails},restart:function(){var i=this.trails;for(var t in i){var e=i[t];e.trail.resetVariables()}this.life=this.options.lifeMin,this.resume()},updateAnim:function(i){if(this.isable){var t=this.ctxFlying;t&&t.clearRect(0,0,t.canvas.width,t.canvas.height),i=i||this.life;for(var e=this.trails,n=0;n<e.length;n++){var a=e[n];a=a.trail,a.updateAnim(i)}}},updateMap:function(){if(this.isable){var i=this.ctxBg;i&&i.clearRect(0,0,i.canvas.width,i.canvas.height);var t=this.ctxFlying;t&&t.clearRect(0,0,t.canvas.width,t.canvas.height);for(var e=this._map.getBounds(),n=this.trails,a=0;a<n.length;a++){var s=n[a];s=s.trail,s&&s.updateMap(e)}}},clean:function(){var i=this.ctxBg;i&&i.clearRect(0,0,i.canvas.width,i.canvas.height);var t=this.ctxFlying;t&&t.clearRect(0,0,t.canvas.width,t.canvas.height)},enable:function(){this.isable=!0,this.resume(),this.updateMap()},disable:function(){this.clean(),this.pause(),this.isable=!1},initEventsMap:function(){var i=this;this._map.on("movestart",function(){i.clean()}).on("moveend",function(){i.updateMap()}.bind(this))},initSpriteFlying:function(){for(var i,t=this.options.trail,e=a(t.color),n=document.createElement("canvas"),s=this.spriteW=n.width=t.spriteW,r=this.spriteH=n.height=t.spriteH,l=n.getContext("2d"),o=l.createLinearGradient(0,0,s,r),h=100,c=0;h>c;c++)i=c/h,o.addColorStop(i,e(i));l.fillStyle=o,l.fillRect(0,0,s,r),this.spriteFlying=n,t.flying.sprite=n},initSpriteFlyingHead:function(){var i=this.options.trail,t=a(i.color),e=document.createElement("canvas"),n=e.width=e.height=50,s=n/2,r=e.getContext("2d");return r.fillStyle=t(1),r.arc(s,s,s,0,2*Math.PI),r.fill(),this.spriteFlyingHead=e,i.flying.spriteHead=e,e},select:function(i){var t,e,n=this.trails;this.clean();for(var a=0;a<n.length;a++)t=n[a],e=t.id,i&&e in i?(t.trail.enable(),t.trail.updateBgLine()):t.trail.disable()},unselect:function(){var i,t=this.trails;this.clean();for(var e=0;e<t.length;e++)i=t[e],i.trail&&i.trail.enable("flying"),i.trail&&i.trail.disable("bgLine")},initSpriteBgLine:function(){var i=this.options.trail;if(i.bgLine){var t=document.createElement("canvas"),e=this.spriteW=t.width=i.spriteW,n=this.spriteH=t.height=i.spriteH,a=t.getContext("2d");return a.fillStyle=this.options.trail.bgLine.color,a.fillRect(0,0,e,n),this.spriteBgLine=t,i.bgLine.sprite=t,t}},initEventsAnim:function(){this.on("lifeEnd",function(){this.pause()}).on("update",function(i){this.updateAnim(i)})},genOptions:function(){return i.prototype.options=e.deepMerge(s.prototype.genOptions(),i.prototype.options)}}),l=t.dmap=t.dmap||{};l.TrailsCanvas=i,l.trailsCanvas=function(t){return new i(t)},i.prototype.genOptions(),module.exports=i;