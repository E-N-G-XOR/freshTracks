"use strict";function t(i){this.options=e.deepMerge(t.options,i),this.initialize(i)}var i=require("./../leaflet"),e=require("./../core/utils"),o=e.Grid,a=e.getColorFunc,n=require("lodash"),r=require("bcore/event");t.options={clusterStepByZoom:1,isAutoUpdate:!0,isNeedAggregate:!0,shape:{type:"hex",rx:20,ry:18,mouseover:{fillOpacity:.8,color:"rgba(255,255,255,0.9)"},mouseout:{fillOpacity:1,color:"rgba(255,255,255,0.0)"},style:{weight:0,fillOpacity:1,color:"rgba(255,255,255,0.0)"},click:{}},color:a("rgba(62,18,0,0.8)","rgba(255,208,122,0.8)","hsl","linear.Out.1.4"),scale:function(){return 1},value:function(t){return Math.min(1,t.length/40)},lng:e.getLng,lat:e.getLat,popup:function(t){return"区域内有: "+t.length+"点"}},t=r.extend(t,{initialize:function(){var t=this.options;this.events={"grid-resize":{desc:"格子大小发生变化"},"grid-mouseover":{desc:"鼠标移至格子范围"},"grid-dblclick":{desc:"双击格子"},"grid-mouseout":{desc:"鼠标移出格子范围"},"grid-click":{desc:"点击某个格子"}},this.gridMap={},this.aggregatedData={},this.getMax=t.getMax,this.getScale=e.getColorFunc(t.shape.scale||t.scale),this.isable=!0},addTo:function(t){!this._map&&t&&(this._map=t,this.initDataProcesser(),this._data&&this.updateZoom())},initDataProcesser:function(){var t=this._map,e=this.options.shape;this.gridEncoder=(new o).transform(function(e,o){var a=t.getSize(),n=a.x/2,r=a.y/2,s=n-e,l=r+o,u=n+e,d=r-o,h=t.containerPointToLatLng(i.point(s,l)),c=t.containerPointToLatLng(i.point(u,d));return{dlat:c.lat-h.lat,dlng:c.lng-h.lng}}).shape(e.type).rx(e.rx).ry(e.ry).update(),this.initEventsMap()},initEventsMap:function(){var t=this;this._map.on("moveend",function(){t.isable&&t.render()}).on("zoomend",function(){t.isable&&t.updateZoom()})},updateZoom:function(){var t=this.options,i=t.clusterStepByZoom,e=this._map;if(t.isNeedAggregate){var o=e.getZoom(),a=Math.floor(o/i);if(a===this.zoomLevel)return;e.closePopup(),this.gridEncoder.update(),this.zoomLevel=a,this.clean(),this.aggregate(),this.fire("grid-resize"),this._updateTransformOrigin()}else;},aggregate:function(){if(this.isable){var t=this.gridEncoder,i=this.options,o=(this._data,i.lat),a=i.lng;this.aggregatedData=e.mapReduce(this._data.filter(function(t){return o(t)&&a(t)}),{map:function(i,e){return{key:t.encode(o(e),a(e)),value:e}}})}},getBounds:function(){var t=this._map.getBounds(),i=t._southWest,e=t._northEast,o=.5*(e.lat-i.lat),a=.5*(e.lng-i.lng);return{latMin:i.lat-o,latMax:e.lat+o,lngMin:i.lng-a,lngMax:e.lng+a}},clean:function(){var t=this.gridMap,i=this._map;for(var e in t){var o=t[e];i.removeLayer(o),delete t[e]}},destroy:function(){this.clean(),this.gridMap={},this.aggregatedData={},this._data=[]},disable:function(){this.isable=!1,this.clean()},enable:function(){this.isable=!0,this.draw()},link:function(){},updateShape:function(){this.clean();var t=this.options.shape,i=t.type,e=t.rx,o=t.ry,a=this.gridEncoder;this._map.closePopup(),a.shape(i),a.rx(e),a.ry(o),a.update(),this.aggregate(),this.draw()},hide:function(){this.each(function(t){t._path.setAttribute("style","opacity:0;")})},show:function(){this.each(function(t){t._path.setAttribute("style","opacity:1;")})},updateColor:function(t,i,o,a){t||(t=this.options.color);var n,r,s=this.getColor=e.getColorFunc(t,i,o,a),l=this.gridMap;for(var u in l)n=l[u],r=n._value,n.setStyle({fillColor:s(r)})},updateOptions:function(t){this.options=e.deepMerge(this.options,t),this.updateColor(),this.updateShape()},updateScale:function(t){t&&(this.scaleGridFunc=function(i,e){if(i){var o=i._container;this._updateTranformOriginGird(o);var a=t(e),n="scale3d("+a+","+a+",1)";o.style.transform=n,o.style["-webkit-transform"]=n,this.getScale=t}})},_updateTranformOriginGird:function(t){if(t){var i=t.getBBox(),e=i.width/2+i.x+"px "+(i.height/2+i.y)+"px 0px";t.style["transform-origin"]=e,t.style["-webkit-transform-origin"]=e}},_updateTransformOrigin:function(){if(this.scaleGridFunc){var t=this.gridMap,i=this;setTimeout(function(){for(var e in t)i._updateTranformOriginGird(t[e]._container)})}},data:function(t){if(!t)return this._data;this._data=t;var i=this.options;i.isAutoUpdate&&this._map&&this.aggregate(),this.updateColor();i.shape},render:function(t){t&&this.data(t),this.draw()},each:function(t){var i=this.gridMap;for(var e in i){var o=i[e];t(o,e)}},draw:function(){if(this.isable){var t,o,a,n,r=this.drawid="id_"+Math.floor(1e10*Math.random()),s=this.options,l=this.gridEncoder,u=s.shape.style,d=e.getColorFunc(s.shape.color||s.color),h=s.value,c=this.aggregatedData,p=this.gridMap,g=this._map,f=this.getBounds(),m=f.latMax,v=f.latMin,_=f.lngMax,y=f.lngMin;for(var M in c)D=c[M],n=h(D),null===n||void 0===n||isNaN(n)||(o||(o=n),a||(a=n),o=Math.min(n,o),a=Math.max(n,a));for(var b in c){var D=c[b],E=l.decode(b),x=E.center,w=E.pts,S=x[0],P=x[1];if(!(v>S||y>P||S>m||P>_)){var n=h(D)||0,T=(n-o)/(a-o)||0,k=d(T);t=p[b],t?(t.setStyle({fillColor:k}),t._drawid=r):(u.fillColor=k,t=p[b]=i.polygon(w,u).addTo(g),t._value=T,t._gridid=b,t._drawid=r,this.initEventsGrid(t),this.scaleGridFunc&&this.scaleGridFunc(t,T))}}for(var G in p)p[G]._drawid!==r&&(g.removeLayer(p[G]),delete p[G]);this._updateTransformOrigin()}},initEventsGrid:function(t){var e,o=this,a=this.aggregatedData,n=this.options.shape,r=n.click||{},s=n.mouseover||{},l=n.mouseout||{},u=t._gridid,d=this._map,h=a[u],c={gridid:u,data:h,layer:t},p=t.getBounds(),g=p._northEast.lat,f=(p._southWest.lng+p._northEast.lng)/2,m=i.latLng(g,f);this.options.popup&&(e=this.options.popup(h,t)),t.on("mouseover",function(e){return s&&t.setStyle(s),o.fire("child-mouseover",c),i.DomEvent.stopPropagation(e),i.DomEvent.preventDefault(e),t.bringToFront(),!0}).on("mouseout",function(e){return l&&t.setStyle(l),o.fire("child-mouseout",c),i.DomEvent.stopPropagation(e),i.DomEvent.preventDefault(e),!0}).on("mousedown",function(a){return r&&t.setStyle(r),o.fire("grid-mousedown",c),d.closePopup(),e&&setTimeout(function(){d.openPopup(e,m)},100),i.DomEvent.stopPropagation(a),i.DomEvent.preventDefault(a),!0}).on("click",function(e){return r&&t.setStyle(r),o.fire("child-click",c),i.DomEvent.stopPropagation(e),i.DomEvent.preventDefault(e),!0}).on("dblclick",function(t){return o.fire("child-dblclick",c),i.DomEvent.stopPropagation(t),i.DomEvent.preventDefault(t),!0})}});var s=i.dmap=i.dmap||{};s.HeatmapGrid=t,s.heatmapGrid=function(i){return t(i)},module.exports=t;